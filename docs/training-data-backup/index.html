<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-training-data-backup" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">训练数据备份方案 - 传输技术对比 | Stars Labs IT 基础架构设计文档</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://stars-labs.github.io/full-it-infra-design-docs/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://stars-labs.github.io/full-it-infra-design-docs/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://stars-labs.github.io/full-it-infra-design-docs/docs/training-data-backup"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="训练数据备份方案 - 传输技术对比 | Stars Labs IT 基础架构设计文档"><meta data-rh="true" name="description" content="场景分析"><meta data-rh="true" property="og:description" content="场景分析"><link data-rh="true" rel="icon" href="/full-it-infra-design-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://stars-labs.github.io/full-it-infra-design-docs/docs/training-data-backup"><link data-rh="true" rel="alternate" href="https://stars-labs.github.io/full-it-infra-design-docs/docs/training-data-backup" hreflang="en"><link data-rh="true" rel="alternate" href="https://stars-labs.github.io/full-it-infra-design-docs/docs/training-data-backup" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"训练数据备份方案 - 传输技术对比","item":"https://stars-labs.github.io/full-it-infra-design-docs/docs/training-data-backup"}]}</script><link rel="stylesheet" href="/full-it-infra-design-docs/assets/css/styles.62962cfa.css">
<script src="/full-it-infra-design-docs/assets/js/runtime~main.552da04d.js" defer="defer"></script>
<script src="/full-it-infra-design-docs/assets/js/main.e00cc15d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/full-it-infra-design-docs/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/full-it-infra-design-docs/"><div class="navbar__logo"><img src="/full-it-infra-design-docs/img/logo.svg" alt="Stars Labs Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/full-it-infra-design-docs/img/logo.svg" alt="Stars Labs Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Stars Labs IT 架构</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/full-it-infra-design-docs/docs/intro">文档</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/stars-labs/full-it-infra-design-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/full-it-infra-design-docs/docs/intro"><span title="项目简介" class="linkLabel_WmDU">项目简介</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/full-it-infra-design-docs/docs/it-infra-design"><span title="IT 基础架构设计方案" class="linkLabel_WmDU">IT 基础架构设计方案</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/full-it-infra-design-docs/docs/switch-selection"><span title="交换机选型方案" class="linkLabel_WmDU">交换机选型方案</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/full-it-infra-design-docs/docs/network-architecture"><span title="网络架构设计" class="linkLabel_WmDU">网络架构设计</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/full-it-infra-design-docs/docs/server-selection"><span title="服务器选型方案" class="linkLabel_WmDU">服务器选型方案</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/full-it-infra-design-docs/docs/storage-solution"><span title="存储方案设计" class="linkLabel_WmDU">存储方案设计</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/full-it-infra-design-docs/docs/nas-hardware-selection"><span title="NAS 硬件选型采购方案" class="linkLabel_WmDU">NAS 硬件选型采购方案</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/full-it-infra-design-docs/docs/security-architecture"><span title="安全架构设计" class="linkLabel_WmDU">安全架构设计</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/full-it-infra-design-docs/docs/datacenter-infra"><span title="机房基础设施设计" class="linkLabel_WmDU">机房基础设施设计</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/full-it-infra-design-docs/docs/training-data-backup"><span title="训练数据备份方案 - 传输技术对比" class="linkLabel_WmDU">训练数据备份方案 - 传输技术对比</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/full-it-infra-design-docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">训练数据备份方案 - 传输技术对比</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>训练数据备份方案 - 传输技术对比</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="场景分析">场景分析<a href="#场景分析" class="hash-link" aria-label="Direct link to 场景分析" title="Direct link to 场景分析" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="两种工作模式">两种工作模式<a href="#两种工作模式" class="hash-link" aria-label="Direct link to 两种工作模式" title="Direct link to 两种工作模式" translate="no">​</a></h3>
<table><thead><tr><th>模式</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>拉取 (Pull)</strong></td><td>服务器监听，客户端连接下载</td><td>文件服务器有公网IP，客户端可主动连接</td></tr><tr><td><strong>推送 (Push)</strong></td><td>客户端主动发起上传</td><td>客户端在NAT后（WFH），无法接收连接</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="wfh-场景的特殊性">WFH 场景的特殊性<a href="#wfh-场景的特殊性" class="hash-link" aria-label="Direct link to WFH 场景的特殊性" title="Direct link to WFH 场景的特殊性" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────┐         ┌─────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   员工电脑      │         │   文件服务器    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  (NAT/防火墙后) │  推送   │  (有公网IP)     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  192.168.1.x    │ ──────&gt; │  1.2.3.4:22     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ❌无公网IP     │  TCP    │  ✅可访问       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ❌无法监听端口 │         │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────┘         └─────────────────┘</span><br></span></code></pre></div></div>
<p><strong>关键问题</strong>：</p>
<ul>
<li class="">WFH员工电脑在家庭路由器NAT后，无法接收UDP/TCP连接</li>
<li class="">只有<strong>推送模式</strong>可行（客户端主动连接服务器）</li>
<li class="">UDP协议（Tsunami/Namida）默认需要客户端监听端口，不支持推送</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="传输模式对比">传输模式对比<a href="#传输模式对比" class="hash-link" aria-label="Direct link to 传输模式对比" title="Direct link to 传输模式对比" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="拉取模式协议需要客户端可访问">拉取模式协议（需要客户端可访问）<a href="#拉取模式协议需要客户端可访问" class="hash-link" aria-label="Direct link to 拉取模式协议（需要客户端可访问）" title="Direct link to 拉取模式协议（需要客户端可访问）" translate="no">​</a></h3>
<table><thead><tr><th>技术</th><th>协议</th><th>速度</th><th>推送模式</th><th>拉取模式</th><th>WFH适用</th></tr></thead><tbody><tr><td>Tsunami UDP</td><td>UDP</td><td><strong>10~12 GB/s</strong></td><td>❌</td><td>✅</td><td>❌</td></tr><tr><td>Namida</td><td>UDP</td><td><strong>10~12 GB/s</strong></td><td>❌</td><td>✅</td><td>❌</td></tr><tr><td>UDT4</td><td>UDP</td><td>8~10 GB/s</td><td>❌</td><td>✅</td><td>❌</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="推送模式协议适合wfh">推送模式协议（适合WFH）<a href="#推送模式协议适合wfh" class="hash-link" aria-label="Direct link to 推送模式协议（适合WFH）" title="Direct link to 推送模式协议（适合WFH）" translate="no">​</a></h3>
<table><thead><tr><th>技术</th><th>协议</th><th>速度</th><th>推送模式</th><th>拉取模式</th><th>WFH适用</th></tr></thead><tbody><tr><td><strong>bbcp</strong></td><td>TCP</td><td><strong>9~11 GB/s</strong></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><strong>mbuffer + tar + ssh</strong></td><td>TCP</td><td><strong>8~10 GB/s</strong></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><strong>GridFTP</strong></td><td>TCP</td><td>8~9 GB/s</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>rclone</td><td>HTTP/gRPC</td><td>5~7 GB/s</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>rsync</td><td>TCP</td><td>3~4 GB/s</td><td>✅</td><td>✅</td><td>✅</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="完整对比表按速度排序">完整对比表（按速度排序）<a href="#完整对比表按速度排序" class="hash-link" aria-label="Direct link to 完整对比表（按速度排序）" title="Direct link to 完整对比表（按速度排序）" translate="no">​</a></h3>
<table><thead><tr><th>技术</th><th>协议</th><th>速度</th><th>推送</th><th>拉取</th><th>WFH支持</th><th>局域网速度</th></tr></thead><tbody><tr><td><strong>Tsunami UDP</strong></td><td>UDP</td><td><strong>极快</strong></td><td>❌</td><td>✅</td><td>❌</td><td>10~12 GB/s</td></tr><tr><td><strong>Namida</strong></td><td>UDP</td><td><strong>极快</strong></td><td>❌</td><td>✅</td><td>❌</td><td>10~12 GB/s</td></tr><tr><td><strong>bbcp</strong></td><td>TCP</td><td><strong>极高</strong></td><td>✅</td><td>✅</td><td>✅</td><td>9~11 GB/s</td></tr><tr><td><strong>mbuffer+tar+ssh</strong></td><td>TCP</td><td><strong>高</strong></td><td>✅</td><td>✅</td><td>✅</td><td>8~10 GB/s</td></tr><tr><td>UDT4</td><td>UDP</td><td>极快</td><td>❌</td><td>✅</td><td>❌</td><td>8~10 GB/s</td></tr><tr><td>GridFTP</td><td>TCP</td><td>极高</td><td>✅</td><td>✅</td><td>✅</td><td>8~9 GB/s</td></tr><tr><td>rclone</td><td>HTTP/gRPC</td><td>高</td><td>✅</td><td>✅</td><td>✅</td><td>5~7 GB/s</td></tr><tr><td>rsync</td><td>TCP</td><td>中</td><td>✅</td><td>✅</td><td>✅</td><td>3~4 GB/s</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="完整对比表按速度排序-1">完整对比表（按速度排序）<a href="#完整对比表按速度排序-1" class="hash-link" aria-label="Direct link to 完整对比表（按速度排序）" title="Direct link to 完整对比表（按速度排序）" translate="no">​</a></h3>
<table><thead><tr><th>技术</th><th>协议</th><th>速度</th><th>推送</th><th>拉取</th><th>WFH支持</th><th>局域网速度</th></tr></thead><tbody><tr><td><strong>Tsunami UDP</strong></td><td>UDP</td><td><strong>极快</strong></td><td>❌</td><td>✅</td><td>❌</td><td>10~12 GB/s</td></tr><tr><td><strong>Namida</strong></td><td>UDP</td><td><strong>极快</strong></td><td>❌</td><td>✅</td><td>❌</td><td>10~12 GB/s</td></tr><tr><td><strong>bbcp</strong></td><td>TCP</td><td><strong>极高</strong></td><td>✅</td><td>✅</td><td>✅</td><td>9~11 GB/s</td></tr><tr><td>UDT4</td><td>UDP</td><td>极快</td><td>❌</td><td>✅</td><td>❌</td><td>8~10 GB/s</td></tr><tr><td>GridFTP</td><td>TCP</td><td>极高</td><td>✅</td><td>✅</td><td>✅</td><td>8~9 GB/s</td></tr><tr><td>rclone</td><td>HTTP/gRPC</td><td>高</td><td>✅</td><td>✅</td><td>✅</td><td>5~7 GB/s</td></tr><tr><td>rsync</td><td>TCP</td><td>中</td><td>✅</td><td>✅</td><td>✅</td><td>3~4 GB/s</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="推荐方案">推荐方案<a href="#推荐方案" class="hash-link" aria-label="Direct link to 推荐方案" title="Direct link to 推荐方案" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="场景1办公室有线网络推荐-namida">场景1：办公室有线网络（推荐 Namida）<a href="#场景1办公室有线网络推荐-namida" class="hash-link" aria-label="Direct link to 场景1：办公室有线网络（推荐 Namida）" title="Direct link to 场景1：办公室有线网络（推荐 Namida）" translate="no">​</a></h3>
<p>在办公室可直接访问文件服务器，使用<strong>Namida拉取模式</strong>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 服务端（文件服务器）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namida serve /data/training/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 客户端（员工电脑）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namida get --server file-server.company.com:5266 dataset.tar.gz</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="场景2wfh远程办公推荐-bbcp">场景2：WFH远程办公（推荐 bbcp）<a href="#场景2wfh远程办公推荐-bbcp" class="hash-link" aria-label="Direct link to 场景2：WFH远程办公（推荐 bbcp）" title="Direct link to 场景2：WFH远程办公（推荐 bbcp）" translate="no">​</a></h3>
<p>在家办公使用<strong>bbcp推送模式</strong>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 客户端（员工电脑）主动推送到文件服务器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bbcp -a -f -w 256M \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -S &quot;ssh -c none -x&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/training/dataset.tar.gz \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    backup@file-server.company.com:/backup/${USER}/</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="场景3混合环境统一用-bbcp">场景3：混合环境（统一用 bbcp）<a href="#场景3混合环境统一用-bbcp" class="hash-link" aria-label="Direct link to 场景3：混合环境（统一用 bbcp）" title="Direct link to 场景3：混合环境（统一用 bbcp）" translate="no">​</a></h3>
<p>为简化运维，<strong>统一使用bbcp推送模式</strong>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 办公室也用推送模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bbcp -a -f -w 256M \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -S &quot;ssh -c none -x&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/training/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    backup@file-server.company.com:/backup/training/</span><br></span></code></pre></div></div>
<p><strong>优势</strong>：</p>
<ul>
<li class="">同一套脚本，办公室和WFH都适用</li>
<li class="">推送模式天然支持NAT穿透</li>
<li class="">速度接近UDP（9~11 GB/s）</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="wfh场景-namida-服务发现问题">WFH场景 Namida 服务发现问题<a href="#wfh场景-namida-服务发现问题" class="hash-link" aria-label="Direct link to WFH场景 Namida 服务发现问题" title="Direct link to WFH场景 Namida 服务发现问题" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="问题描述">问题描述<a href="#问题描述" class="hash-link" aria-label="Direct link to 问题描述" title="Direct link to 问题描述" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────┐                    ┌─────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   员工电脑      │                    │   文件服务器    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  (NAT后，可监听) │   UDP数据通道     │  (有公网IP)     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  监听: 5266     │ ◄──────────────── │  发起连接       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                 │                    │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  问题:          │                    │  问题:          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 无固定IP     │                    │  - 不知道客户端 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - IP动态变化   │                    │    当前IP       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────┘                    └─────────────────┘</span><br></span></code></pre></div></div>
<p><strong>核心问题</strong>：客户端可以接收UDP包，但文件服务器不知道客户端的当前IP和端口。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="解决方案对比">解决方案对比<a href="#解决方案对比" class="hash-link" aria-label="Direct link to 解决方案对比" title="Direct link to 解决方案对比" translate="no">​</a></h3>
<table><thead><tr><th>方案</th><th>原理</th><th>速度</th><th>复杂度</th><th>推荐度</th></tr></thead><tbody><tr><td><strong>方案A：客户端注册</strong></td><td>客户端主动告知服务器自己的IP<!-- -->:Port</td><td>10~12 GB/s</td><td>中</td><td>⭐⭐⭐</td></tr><tr><td><strong>方案B：心跳保活</strong></td><td>定期发送UDP心跳包带IP信息</td><td>10~12 GB/s</td><td>中</td><td>⭐⭐⭐</td></tr><tr><td><strong>方案C：反向连接</strong></td><td>客户端先TCP连接告知，再UDP接收</td><td>9~11 GB/s</td><td>高</td><td>⭐⭐</td></tr><tr><td><strong>方案D：改用bbcp推送</strong></td><td>客户端主动推送，不依赖服务发现</td><td>9~11 GB/s</td><td>低</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="方案a客户端注册--namida拉取">方案A：客户端注册 + Namida拉取<a href="#方案a客户端注册--namida拉取" class="hash-link" aria-label="Direct link to 方案A：客户端注册 + Namida拉取" title="Direct link to 方案A：客户端注册 + Namida拉取" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ~/scripts/namida-register.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 客户端注册脚本：告知服务器自己的位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVER=&quot;file-server.company.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REG_PORT=&quot;5267&quot;      # 注册端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DATA_PORT=&quot;5266&quot;     # Namida数据端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CLIENT_IP=$(curl -s ifconfig.me || hostname -I | awk &#x27;{print $1}&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CLIENT_PORT=${1:-$DATA_PORT}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)] [register] $*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 1. 启动Namida数据服务（监听数据端口）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namida serve /data/training/ --port ${DATA_PORT} &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMIDA_PID=$!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log &quot;Namida服务启动 PID: $NAMIDA_PID, 端口: ${DATA_PORT}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2. 向服务器注册自己的位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log &quot;向服务器注册: ${CLIENT_IP}:${CLIENT_PORT}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;${CLIENT_IP}:${CLIENT_PORT}&quot; | nc -w1 ${SERVER} ${REG_PORT}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3. 等待传输完成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log &quot;等待传输请求...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wait $NAMIDA_PID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log &quot;完成&quot;</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ~/scripts/namida-server.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 服务端：接收客户端注册，发起拉取</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REG_PORT=&quot;5267&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DATA_DIR=&quot;/backup/pending&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p ${DATA_DIR}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)] [server] $*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 监听注册请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log &quot;等待客户端注册...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while true; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 接收客户端IP:Port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CLIENT_INFO=$(timeout 60 nc -l -p ${REG_PORT} 2&gt;/dev/null) || continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ -n &quot;$CLIENT_INFO&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CLIENT_IP=$(echo $CLIENT_INFO | cut -d: -f1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CLIENT_PORT=$(echo $CLIENT_INFO | cut -d: -f2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TIMESTAMP=$(date +%Y%m%d_%H%M%S)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;收到注册: ${CLIENT_IP}:${CLIENT_PORT} at ${TIMESTAMP}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 启动Namida连接客户端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 注意：这里需要Namida支持作为客户端发起连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实际使用时可能需要修改Namida源码或使用其他工具</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        timeout 300 namida get --server ${CLIENT_IP}:${CLIENT_PORT} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            --output ${DATA_DIR}/from_${CLIENT_IP}_${TIMESTAMP}/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;传输完成: ${CLIENT_IP}:${CLIENT_PORT}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="方案budp心跳注册简化版">方案B：UDP心跳注册（简化版）<a href="#方案budp心跳注册简化版" class="hash-link" aria-label="Direct link to 方案B：UDP心跳注册（简化版）" title="Direct link to 方案B：UDP心跳注册（简化版）" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ~/scripts/namida-heartbeat.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 心跳保活 + 服务发现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVER=&quot;file-server.company.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REG_PORT=&quot;5267&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CLIENT_PORT=&quot;5266&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INTERVAL=30  # 心跳间隔30秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 获取客户端真实IP（可能在内网）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CLIENT_IP=$(curl -s ifconfig.me 2&gt;/dev/null || echo &quot;unknown&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)] [heartbeat] $*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 启动Namida服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namida serve /data/training/ --port ${CLIENT_PORT} &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log &quot;Namida启动: ${CLIENT_PORT}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 发送心跳</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while true; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;心跳: ${CLIENT_IP}:${CLIENT_PORT}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;${CLIENT_IP}:${CLIENT_PORT}:$(date +%s)&quot; | nc -w1 ${SERVER} ${REG_PORT}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sleep ${INTERVAL}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="方案对比与推荐">方案对比与推荐<a href="#方案对比与推荐" class="hash-link" aria-label="Direct link to 方案对比与推荐" title="Direct link to 方案对比与推荐" translate="no">​</a></h3>
<table><thead><tr><th>场景</th><th>推荐方案</th><th>原因</th></tr></thead><tbody><tr><td><strong>纯办公室</strong></td><td>Namida拉取</td><td>无NAT问题，最快</td></tr><tr><td><strong>WFH，固定时间备份</strong></td><td>bbcp推送</td><td>简单可靠，NAT友好</td></tr><tr><td><strong>WFH，需要Namida速度</strong></td><td>客户端注册</td><td>速度最快，但需要额外开发</td></tr><tr><td><strong>混合团队</strong></td><td>统一bbcp推送</td><td>运维简单，速度可接受</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="推荐统一使用-bbcp-推送模式">推荐：统一使用 bbcp 推送模式<a href="#推荐统一使用-bbcp-推送模式" class="hash-link" aria-label="Direct link to 推荐：统一使用 bbcp 推送模式" title="Direct link to 推荐：统一使用 bbcp 推送模式" translate="no">​</a></h3>
<p>对于50人规模团队，<strong>强烈建议统一使用bbcp推送模式</strong>：</p>
<p><strong>理由</strong>：</p>
<ol>
<li class=""><strong>无需服务发现</strong> - 客户端主动连接，服务器被动接收</li>
<li class=""><strong>NAT穿透友好</strong> - TCP连接天然支持NAT</li>
<li class=""><strong>运维简单</strong> - 同一套脚本，办公室和WFH通用</li>
<li class=""><strong>速度足够</strong> - 9~11 GB/s（局域网），接近UDP</li>
<li class=""><strong>防火墙友好</strong> - 使用标准SSH端口22或自定义端口</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># WFH推送命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bbcp -a -f -w 256M \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -S &quot;ssh -c none -x&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/training/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    backup@file-server.company.com:/backup/training/</span><br></span></code></pre></div></div>
<p><strong>如果坚持使用Namida</strong>：需要额外开发客户端注册系统，或考虑商业解决方案（如Aspera FASP）。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="速度优先推荐方案namida仅限办公室">速度优先推荐方案：Namida（仅限办公室）<a href="#速度优先推荐方案namida仅限办公室" class="hash-link" aria-label="Direct link to 速度优先推荐方案：Namida（仅限办公室）" title="Direct link to 速度优先推荐方案：Namida（仅限办公室）" translate="no">​</a></h2>
<p>对于<strong>只关心传输速度且在办公室</strong>的场景，<strong>Namida</strong> 是最佳选择：</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="namida-优势">Namida 优势<a href="#namida-优势" class="hash-link" aria-label="Direct link to Namida 优势" title="Direct link to Namida 优势" translate="no">​</a></h3>
<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>UDP裸传</strong></td><td>无TCP拥塞控制，占满带宽</td></tr><tr><td><strong>极低CPU占用</strong></td><td>&lt;5%，无加密开销</td></tr><tr><td><strong>现代化实现</strong></td><td>Rust重写，活跃维护</td></tr><tr><td><strong>默认加密</strong></td><td>使用snow加密通信</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="namida-安装">Namida 安装<a href="#namida-安装" class="hash-link" aria-label="Direct link to Namida 安装" title="Direct link to Namida 安装" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 源码编译</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget https://github.com/kthe/tsunami-udp/archive/refs/heads/master.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unzip master.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd tsunami-udp-master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make -j$(nproc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo cp tsunami /usr/local/bin/</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="tsunami-udp-使用">Tsunami UDP 使用<a href="#tsunami-udp-使用" class="hash-link" aria-label="Direct link to Tsunami UDP 使用" title="Direct link to Tsunami UDP 使用" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 接收端（先启动）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami&gt; set peer 0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami&gt; set port 46200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami&gt; receive /backup/dataset.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 发送端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami&gt; set peer 192.168.1.100  # 接收端IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami&gt; set port 46200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami&gt; send /data/training/dataset.tar.gz</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="tsunami-udp-完整脚本">Tsunami UDP 完整脚本<a href="#tsunami-udp-完整脚本" class="hash-link" aria-label="Direct link to Tsunami UDP 完整脚本" title="Direct link to Tsunami UDP 完整脚本" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -/scripts/backup-tsunami.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 训练数据备份 - Tsunami UDP极速版</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -euo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_HOST=&quot;192.168.1.100&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_PORT=&quot;46200&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_PATH=&quot;/backup/${USER}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SOURCE_PATHS=(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/training&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/models&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/experiments&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_DIR=&quot;${HOME}/.local/share/backup/logs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)] $*&quot; | tee -a &quot;${LOG_DIR}/tsunami_$(date +%Y%m%d).log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run_backup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local src=&quot;$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ ! -d &quot;${src}&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;跳过: ${src} 不存在&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;备份: ${src} -&gt; ${NAS_HOST}:${NAS_PATH}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Tsunami UDP 传输</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;set peer ${NAS_HOST}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;set port ${NAS_PORT}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;set buffer 16777216&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;send ${src}/*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;quit&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } | timeout 86400 tsunami 2&gt;&amp;1 | while read line; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;  $line&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ ${PIPESTATUS[0]} -eq 0 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;完成: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        find &quot;${src}&quot; -type f -delete 2&gt;/dev/null || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;错误: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p &quot;${LOG_DIR}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== Tsunami UDP备份开始 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for path in &quot;${SOURCE_PATHS[@]}&quot;; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        run_backup &quot;${path}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== Tsunami UDP备份完成 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main &quot;$@&quot;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="wfh推荐方案bbcp推送模式">WFH推荐方案：bbcp（推送模式）<a href="#wfh推荐方案bbcp推送模式" class="hash-link" aria-label="Direct link to WFH推荐方案：bbcp（推送模式）" title="Direct link to WFH推荐方案：bbcp（推送模式）" translate="no">​</a></h2>
<p>对于<strong>WFH远程办公</strong>场景，<strong>bbcp</strong> 是最佳选择：</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="为什么-bbcp-适合-wfh">为什么 bbcp 适合 WFH<a href="#为什么-bbcp-适合-wfh" class="hash-link" aria-label="Direct link to 为什么 bbcp 适合 WFH" title="Direct link to 为什么 bbcp 适合 WFH" translate="no">​</a></h3>
<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>推送模式</strong></td><td>客户端主动连接服务器，天然穿透NAT</td></tr><tr><td><strong>TCP协议</strong></td><td>使用标准TCP，防火墙友好</td></tr><tr><td><strong>超高速度</strong></td><td>9~11 GB/s（10Gbps局域网），接近UDP</td></tr><tr><td><strong>无加密选项</strong></td><td>可禁用SSH加密，进一步提升速度</td></tr><tr><td><strong>并行传输</strong></td><td>多文件同时传输</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="bbcp-vs-namida-对比wfh场景">bbcp vs Namida 对比（WFH场景）<a href="#bbcp-vs-namida-对比wfh场景" class="hash-link" aria-label="Direct link to bbcp vs Namida 对比（WFH场景）" title="Direct link to bbcp vs Namida 对比（WFH场景）" translate="no">​</a></h3>
<table><thead><tr><th>特性</th><th>Namida</th><th>bbcp</th><th>WFH适用性</th></tr></thead><tbody><tr><td>传输模式</td><td>拉取</td><td><strong>推送</strong></td><td>bbcp ✅</td></tr><tr><td>NAT穿透</td><td>❌</td><td>✅</td><td>bbcp ✅</td></tr><tr><td>10Gbps速度</td><td>10~12 GB/s</td><td>9~11 GB/s</td><td>差异极小</td></tr><tr><td>跨公网</td><td>困难</td><td>✅</td><td>bbcp ✅</td></tr><tr><td>防火墙友好</td><td>❌</td><td>✅</td><td>bbcp ✅</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="bbcp-安装">bbcp 安装<a href="#bbcp-安装" class="hash-link" aria-label="Direct link to bbcp 安装" title="Direct link to bbcp 安装" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Ubuntu/Debian</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt install bbcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 或源码编译</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/ltp/bbcp.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd bbcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make -j$(nproc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo make install</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="bbcp-wfh推送脚本">bbcp WFH推送脚本<a href="#bbcp-wfh推送脚本" class="hash-link" aria-label="Direct link to bbcp WFH推送脚本" title="Direct link to bbcp WFH推送脚本" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ~/scripts/backup-bbcp-wfh.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># WFH场景：bbcp推送模式（客户端主动上传）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -euo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_HOST=&quot;${NAS_HOST:-backup.company.com}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_USER=&quot;${NAS_USER:-backup}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_PATH=&quot;/backup/${USER}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SOURCE_PATHS=(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/training&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/models&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/experiments&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TCP_WINDOW=&quot;256M&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_DIR=&quot;${HOME}/.local/share/backup/logs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)] [bbcp] $*&quot; | tee -a &quot;${LOG_DIR}/bbcp_wfh_$(date +%Y%m%d).log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run_backup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local src=&quot;$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local dst=&quot;${NAS_USER}@${NAS_HOST}:${NAS_PATH}$(dirname ${src})&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ ! -d &quot;${src}&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;跳过: ${src} 不存在&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;推送: ${src} -&gt; ${dst}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;  TCP窗口: ${TCP_WINDOW}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # bbcp推送模式（无加密，极速）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bbcp -a -f -w &quot;${TCP_WINDOW}&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -S &quot;ssh -c none -x -o Compression=no -o BatchMode=yes -o StrictHostKeyChecking=no&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --ignore-permissions \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;${src}/&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;${dst}/&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        2&gt;&amp;1 | while read line; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log &quot;  $line&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ ${PIPESTATUS[0]} -eq 0 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;完成: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        find &quot;${src}&quot; -type f -delete 2&gt;/dev/null || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;错误: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p &quot;${LOG_DIR}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== bbcp WFH推送开始 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;目标: ${NAS_USER}@${NAS_HOST}:${NAS_PATH}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;模式: 推送（主动连接）&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for path in &quot;${SOURCE_PATHS[@]}&quot;; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        run_backup &quot;${path}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== bbcp WFH推送完成 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main &quot;$@&quot;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="备选方案mbuffer--tar--ssh">备选方案：mbuffer + tar + ssh<a href="#备选方案mbuffer--tar--ssh" class="hash-link" aria-label="Direct link to 备选方案：mbuffer + tar + ssh" title="Direct link to 备选方案：mbuffer + tar + ssh" translate="no">​</a></h2>
<p><strong>mbuffer</strong> 是一个<strong>缓冲工具</strong>，不是传输协议。它通过大缓冲来避免IO瓶颈，常与 <code>tar + ssh</code> 配合使用。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="mbuffer-vs-bbcp-对比">mbuffer vs bbcp 对比<a href="#mbuffer-vs-bbcp-对比" class="hash-link" aria-label="Direct link to mbuffer vs bbcp 对比" title="Direct link to mbuffer vs bbcp 对比" translate="no">​</a></h3>
<table><thead><tr><th>特性</th><th>mbuffer + tar + ssh</th><th>bbcp</th><th>Namida</th></tr></thead><tbody><tr><td><strong>类型</strong></td><td>缓冲组件</td><td>传输协议</td><td>传输协议</td></tr><tr><td><strong>传输速度</strong></td><td>8~10 GB/s</td><td>9~11 GB/s</td><td>10~12 GB/s</td></tr><tr><td><strong>推送模式</strong></td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><strong>拉取模式</strong></td><td>✅ (需nc)</td><td>✅</td><td>✅</td></tr><tr><td><strong>WFH适用</strong></td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><strong>复杂度</strong></td><td>中（3个组件）</td><td>低（单命令）</td><td>低（单命令）</td></tr><tr><td><strong>灵活性</strong></td><td>高</td><td>中</td><td>中</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="性能验证">性能验证<a href="#性能验证" class="hash-link" aria-label="Direct link to 性能验证" title="Direct link to 性能验证" translate="no">​</a></h3>
<p>根据 <a href="https://serverfault.com/questions/332606" target="_blank" rel="noopener noreferrer" class="">ServerFault 实践</a> 和 <a href="https://github.com/zrepl/zrepl/issues/86" target="_blank" rel="noopener noreferrer" class="">ZFS社区测试</a>：</p>
<ul>
<li class=""><code>tar + mbuffer + ssh</code> 可达到 <strong>950 Mbps+</strong>（1Gbps网络）</li>
<li class="">ZFS send/receive 场景：从 <strong>2.5 Gbps 提升到 4 Gbps</strong>（使用mbuffer）</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="mbuffer-安装">mbuffer 安装<a href="#mbuffer-安装" class="hash-link" aria-label="Direct link to mbuffer 安装" title="Direct link to mbuffer 安装" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Ubuntu/Debian</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt install mbuffer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># macOS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brew install mbuffer</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="mbuffer-基础用法">mbuffer 基础用法<a href="#mbuffer-基础用法" class="hash-link" aria-label="Direct link to mbuffer 基础用法" title="Direct link to mbuffer 基础用法" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 基础传输（带缓冲）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar -cf - /data/training/ | mbuffer -s 128k -m 1G | ssh -c arcfour128 user@server &quot;tar -xf -&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 关键参数说明：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -s 128k: 块大小128KB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -m 1G:  总缓冲1GB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -c arcfour128: 快速SSH加密（比AES快）</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="mbuffer--bbcp-完整脚本">mbuffer + bbcp 完整脚本<a href="#mbuffer--bbcp-完整脚本" class="hash-link" aria-label="Direct link to mbuffer + bbcp 完整脚本" title="Direct link to mbuffer + bbcp 完整脚本" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ~/scripts/backup-mbuffer.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># mbuffer + tar + bbcp 组合方案</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -euo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_HOST=&quot;backup.company.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_USER=&quot;backup&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_PATH=&quot;/backup/${USER}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SOURCE_DIR=&quot;/data/training&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BUFFER_SIZE=&quot;1G&quot;       # 缓冲大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BLOCK_SIZE=&quot;128k&quot;      # 块大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_DIR=&quot;${HOME}/.local/share/backup/logs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)] [mbuffer] $*&quot; | tee -a &quot;${LOG_DIR}/mbuffer_$(date +%Y%m%d).log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backup_mbuffer() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;开始备份: ${SOURCE_DIR}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;缓冲: ${BUFFER_SIZE}, 块大小: ${BLOCK_SIZE}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 方法1: tar + mbuffer + ssh（传统方式）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tar -cf - -C &quot;$(dirname ${SOURCE_DIR})&quot; &quot;$(basename ${SOURCE_DIR})&quot; | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mbuffer -s ${BLOCK_SIZE} -m ${BUFFER_SIZE} -q | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ssh -c arcfour128 -o Compression=no -o BatchMode=yes \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ${NAS_USER}@${NAS_HOST} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;mbuffer -s ${BLOCK_SIZE} -m ${BUFFER_SIZE} -q &gt; ${NAS_PATH}/backup_$(date +%Y%m%d).tar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ $? -eq 0 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;完成: ${SOURCE_DIR}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;错误: ${SOURCE_DIR}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 方法2: mbuffer + nc（无加密，极速）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backup_mbuffer_nc() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;使用mbuffer + nc（无加密模式）&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 接收端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssh ${NAS_USER}@${NAS_HOST} &quot;mbuffer -s ${BLOCK_SIZE} -m ${BUFFER_SIZE} -I 9090 &gt; ${NAS_PATH}/backup.tar&quot; &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 发送端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tar -cf - ${SOURCE_DIR} | mbuffer -s ${BLOCK_SIZE} -m ${BUFFER_SIZE} -O ${NAS_HOST}:9090</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;完成&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p &quot;${LOG_DIR}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== mbuffer备份开始 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # WFH场景使用mbuffer + ssh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    backup_mbuffer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== mbuffer备份完成 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main &quot;$@&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="mbuffer-性能调优">mbuffer 性能调优<a href="#mbuffer-性能调优" class="hash-link" aria-label="Direct link to mbuffer 性能调优" title="Direct link to mbuffer 性能调优" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 不同场景的缓冲配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 场景1: 10Gbps局域网，极速</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar -cf - data/ | mbuffer -s 256k -m 4G | ssh -c arcfour128 host &quot;tar -xf -&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 场景2: 1Gbps网络，平衡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar -cf - data/ | mbuffer -s 128k -m 1G | ssh -c arcfour128 host &quot;tar -xf -&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 场景3: 跨公网，高延迟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar -cf - data/ | mbuffer -s 64k -m 512M | ssh -c arcfour128 host &quot;tar -xf -&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 场景4: ZFS send/receive（性能翻倍）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 接收端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mbuffer -s 128k -m 1G -I 5005 | zfs receive pool/dataset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 发送端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zfs send -R pool@dataset | mbuffer -s 128k -m 1G -O server:5005</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="mbuffer-systemd-timer">mbuffer Systemd Timer<a href="#mbuffer-systemd-timer" class="hash-link" aria-label="Direct link to mbuffer Systemd Timer" title="Direct link to mbuffer Systemd Timer" translate="no">​</a></h3>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ~/.config/systemd/user/backup-mbuffer.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=训练数据备份 (mbuffer+tar+ssh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After=network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type=oneshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=%h/scripts/backup-mbuffer.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StandardOutput=append:%h/.local/share/backup/logs/mbuffer.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StandardError=append:%h/.local/share/backup/logs/mbuffer.error.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=default.target</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="mbuffer-选择建议">mbuffer 选择建议<a href="#mbuffer-选择建议" class="hash-link" aria-label="Direct link to mbuffer 选择建议" title="Direct link to mbuffer 选择建议" translate="no">​</a></h3>
<p><strong>推荐使用 mbuffer 的场景：</strong></p>
<ul>
<li class="">✅ 已有 tar/ssh 基础设施</li>
<li class="">✅ 需要精确控制缓冲大小</li>
<li class="">✅ ZFS send/receive 场景（性能提升明显）</li>
<li class="">✅ 磁盘IO是瓶颈的场景</li>
</ul>
<p><strong>继续使用 bbcp 的场景：</strong></p>
<ul>
<li class="">✅ 追求简单（单命令）</li>
<li class="">✅ 需要内置校验</li>
<li class="">✅ 多文件并行传输</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="bbcp-systemd-timerwfh场景">bbcp Systemd Timer（WFH场景）<a href="#bbcp-systemd-timerwfh场景" class="hash-link" aria-label="Direct link to bbcp Systemd Timer（WFH场景）" title="Direct link to bbcp Systemd Timer（WFH场景）" translate="no">​</a></h3>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ~/.config/systemd/user/backup-bbcp-wfh.timer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=每天22:00自动备份训练数据 (bbcp WFH推送)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Timer]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OnCalendar=*-*-* 22:00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Persistent=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RandomizedDelaySec=30min</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=timers.target</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="wfh场景完整方案对比">WFH场景完整方案对比<a href="#wfh场景完整方案对比" class="hash-link" aria-label="Direct link to WFH场景完整方案对比" title="Direct link to WFH场景完整方案对比" translate="no">​</a></h3>
<table><thead><tr><th>场景</th><th>推荐方案</th><th>速度</th><th>说明</th></tr></thead><tbody><tr><td><strong>办公室有线</strong></td><td>Namida拉取</td><td><strong>10~12 GB/s</strong></td><td>最快速度，适合大文件</td></tr><tr><td><strong>办公室无线</strong></td><td>bbcp推送</td><td>5~8 GB/s</td><td>无线网络瓶颈</td></tr><tr><td><strong>WFH家庭网络</strong></td><td>bbcp推送</td><td>500~1000 Mbps</td><td>受限于家庭带宽</td></tr><tr><td><strong>跨公网传输</strong></td><td>bbcp推送</td><td>100~500 Mbps</td><td>取决于公网带宽</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="统一备份脚本自动适配">统一备份脚本（自动适配）<a href="#统一备份脚本自动适配" class="hash-link" aria-label="Direct link to 统一备份脚本（自动适配）" title="Direct link to 统一备份脚本（自动适配）" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ~/scripts/backup-universal.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 统一备份脚本：自动检测网络环境，选择最佳方案</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -euo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_HOST=&quot;backup.company.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_USER=&quot;backup&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_PATH=&quot;/backup/${USER}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_DIR=&quot;${HOME}/.local/share/backup/logs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 检测是否在办公室（通过DNS或IP判断）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">detect_office() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 方法1: 检查是否能访问内部服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ping -c 1 -W 1 file-server.internal &amp;&gt;/dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 方法2: 检查IP是否在办公网段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local ip=$(hostname -I 2&gt;/dev/null | awk &#x27;{print $1}&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [[ &quot;$ip&quot; =~ ^192\.168\.(1|10)\. ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 1  # WFH模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)] $*&quot; | tee -a &quot;${LOG_DIR}/backup_$(date +%Y%m%d).log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Namida拉取模式（办公室）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backup_namida() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;模式: Namida拉取（办公室）&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namida get --server &quot;${NAS_HOST}:5266&quot; --all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># bbcp推送模式（WFH）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backup_bbcp() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;模式: bbcp推送（WFH/NAT后）&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SOURCE_PATHS=(&quot;/data/training&quot; &quot;/data/models&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for path in &quot;${SOURCE_PATHS[@]}&quot;; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if [ -d &quot;${path}&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            local dst=&quot;${NAS_USER}@${NAS_HOST}:${NAS_PATH}$(dirname ${path})&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log &quot;推送: ${path} -&gt; ${dst}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bbcp -a -f -w 256M \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -S &quot;ssh -c none -x -o Compression=no -o BatchMode=yes&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;${path}/&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;${dst}/&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                2&gt;&amp;1 | while read line; do log &quot;  $line&quot;; done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p &quot;${LOG_DIR}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== 统一备份开始 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if detect_office; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检查namida是否可用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if command -v namida &amp;&gt;/dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            backup_namida</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log &quot;Namida不可用，回退到bbcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            backup_bbcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        backup_bbcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== 备份完成 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main &quot;$@&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="方案选择决策树">方案选择决策树<a href="#方案选择决策树" class="hash-link" aria-label="Direct link to 方案选择决策树" title="Direct link to 方案选择决策树" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                    开始备份</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ▼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ┌───────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              │ 是否在办公网络？   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              └─────────┬─────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ┌───────────┴───────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ▼                       ▼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          是                      否</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           │                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ▼                       ▼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ┌──────────────┐        ┌──────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │ Namida可用？ │        │ 使用bbcp推送 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └──────┬───────┘        │ (NAT穿透)    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           │                └──────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ┌────┴────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     是         否</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ▼          ▼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Namida拉取   bbcp推送</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (最快10+GB/s)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="最终推荐配置">最终推荐配置<a href="#最终推荐配置" class="hash-link" aria-label="Direct link to 最终推荐配置" title="Direct link to 最终推荐配置" translate="no">​</a></h3>
<table><thead><tr><th>场景</th><th>命令</th><th>预期速度</th></tr></thead><tbody><tr><td><strong>办公室</strong></td><td><code>namida get --server file-server:5266 --all</code></td><td>10~12 GB/s</td></tr><tr><td><strong>WFH</strong></td><td><code>bbcp -a -f -w 256M /data/ user@server:/backup/</code></td><td>100~1000 Mbps</td></tr><tr><td><strong>统一脚本</strong></td><td><code>~/scripts/backup-universal.sh</code></td><td>自动适配</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="bbcp-多文件并行传输">bbcp 多文件并行传输<a href="#bbcp-多文件并行传输" class="hash-link" aria-label="Direct link to bbcp 多文件并行传输" title="Direct link to bbcp 多文件并行传输" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 并行传输多个文件（推荐）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bbcp -a -f -w 256M \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -S &quot;ssh -c none -x&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/training/*.tar.gz \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/models/*.tar.gz \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user@nas:/backup/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 递归传输目录 + 并行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bbcp -a -f -w 256M \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -S &quot;ssh -c none -x&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/training/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/models/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user@nas:/backup/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 带进度显示</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bbcp -a -f -w 256M -v \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -S &quot;ssh -c none -x&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/largefile.tar.gz \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user@nas:/backup/</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="systemd-timer配置bbcp极速版">Systemd Timer配置（bbcp极速版）<a href="#systemd-timer配置bbcp极速版" class="hash-link" aria-label="Direct link to Systemd Timer配置（bbcp极速版）" title="Direct link to Systemd Timer配置（bbcp极速版）" translate="no">​</a></h3>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># -/.config/systemd/user/backup-bbcp-fast.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=训练数据备份 (bbcp极速版)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After=network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Wants=network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type=oneshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=%h/scripts/backup-bbcp-fast.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Environment=&quot;FORCE_BACKUP=false&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StandardOutput=append:%h/.local/share/backup/logs/bbcp_fast.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StandardError=append:%h/.local/share/backup/logs/bbcp_fast.error.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=default.target</span><br></span></code></pre></div></div>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># -/.config/systemd/user/backup-bbcp-fast.timer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=每天22:00自动备份训练数据 (bbcp极速版)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Timer]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OnCalendar=*-*-* 22:00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Persistent=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RandomizedDelaySec=5min</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=timers.target</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="gridftp-极速配置可选">GridFTP 极速配置（可选）<a href="#gridftp-极速配置可选" class="hash-link" aria-label="Direct link to GridFTP 极速配置（可选）" title="Direct link to GridFTP 极速配置（可选）" translate="no">​</a></h3>
<p>如果需要更极致的性能，可以使用 GridFTP：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt install globus-toolkit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># GridFTP 极速传输（无加密）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">globus-url-copy -cd -bb -p 32 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file:///data/training/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ftp://user@nas:2811/backup/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 选项说明:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -cd: 递归创建目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -bb: 批量模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -p 32: 32个并行连接</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="bbcp-优势速度优先">bbcp 优势（速度优先）<a href="#bbcp-优势速度优先" class="hash-link" aria-label="Direct link to bbcp 优势（速度优先）" title="Direct link to bbcp 优势（速度优先）" translate="no">​</a></h3>
<table><thead><tr><th>特性</th><th>bbcp (无加密)</th><th>bbcp (SSH)</th><th>rsync</th><th>rclone</th></tr></thead><tbody><tr><td>单文件速度</td><td><strong>9~11 GB/s</strong></td><td>7~9 GB/s</td><td>3~4 GB/s</td><td>5~7 GB/s</td></tr><tr><td>多文件并行</td><td>✅</td><td>✅</td><td>❌</td><td>✅</td></tr><tr><td>CPU占用</td><td><strong>极低</strong></td><td>低</td><td>高</td><td>中</td></tr><tr><td>内存占用</td><td>低</td><td>低</td><td>中</td><td>中</td></tr><tr><td>断点续传</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>加密</td><td>❌</td><td>✅</td><td>✅</td><td>可选</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="bbcp-安装-1">bbcp 安装<a href="#bbcp-安装-1" class="hash-link" aria-label="Direct link to bbcp 安装" title="Direct link to bbcp 安装" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Ubuntu/Debian</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt install bbcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 或源码编译</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/ltp/bbcp.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd bbcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo make install</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="bbcp-使用">bbcp 使用<a href="#bbcp-使用" class="hash-link" aria-label="Direct link to bbcp 使用" title="Direct link to bbcp 使用" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 基本用法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bbcp -s -z -T &quot;ssh -c aes128-ctr -i -/.ssh/id_ed25519&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/training/dataset.tar.gz \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user@nas:/backup/dataset.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 选项说明:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -s: 静默模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -z: 压缩传输</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -T: 指定SSH命令（加密方式）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -p: 保留权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -a: 显示进度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 多文件并行传输</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bbcp -s -z -T &quot;ssh -c aes128-ctr&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/training/*.tar.gz \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user@nas:/backup/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 带校验</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bbcp -s -z -V -T &quot;ssh -c aes128-ctr&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/training/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user@nas:/backup/</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="bbcp-完整脚本">bbcp 完整脚本<a href="#bbcp-完整脚本" class="hash-link" aria-label="Direct link to bbcp 完整脚本" title="Direct link to bbcp 完整脚本" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -/scripts/backup-bbcp.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># bbcp高速备份脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -euo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_HOST=&quot;backup.nas.stars-labs.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_USER=&quot;${USER}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_PATH=&quot;/backup/${USER}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SOURCE_PATHS=(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/training&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/models&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BW_LIMIT=&quot;&quot;  # bbcp自动适应</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_DIR=&quot;${HOME}/.local/share/backup/logs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)] $*&quot; | tee -a &quot;${LOG_DIR}/bbcp_$(date +%Y%m%d).log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run_backup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local src=&quot;$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local dst=&quot;${NAS_USER}@${NAS_HOST}:${NAS_PATH}$(dirname ${src})&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;备份: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # bbcp命令:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # -a: 保留属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # -z: 压缩</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # -v: 详细</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # -f: 强制覆盖</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # -w: 窗口大小 (16MB适合高RTT网络)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # -T: SSH命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bbcp -a -z -f -w 64M \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -T &quot;ssh -c aes128-ctr -i -/.ssh/id_ed25519 -o Compression=no&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;${src}/&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;${dst}/&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        2&gt;&amp;1 | tee -a &quot;${LOG_DIR}/bbcp_$(date +%Y%m%d).log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 传输完成后删除源文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ $? -eq 0 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;删除源文件: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rm -rf &quot;${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p &quot;${LOG_DIR}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== bbcp备份开始 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for path in &quot;${SOURCE_PATHS[@]}&quot;; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if [ -d &quot;${path}&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            run_backup &quot;${path}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== bbcp备份完成 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main &quot;$@&quot;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="速度优化参数对比">速度优化参数对比<a href="#速度优化参数对比" class="hash-link" aria-label="Direct link to 速度优化参数对比" title="Direct link to 速度优化参数对比" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="不同网络环境的最佳选择速度优先">不同网络环境的最佳选择（速度优先）<a href="#不同网络环境的最佳选择速度优先" class="hash-link" aria-label="Direct link to 不同网络环境的最佳选择（速度优先）" title="Direct link to 不同网络环境的最佳选择（速度优先）" translate="no">​</a></h3>
<table><thead><tr><th>网络环境</th><th>推荐技术</th><th>关键参数</th><th>预期速度</th><th>丢包敏感度</th></tr></thead><tbody><tr><td><strong>优质局域网</strong></td><td>Tsunami UDP</td><td>默认参数</td><td><strong>10~12 GB/s</strong></td><td>极低</td></tr><tr><td><strong>10Gbps局域网</strong></td><td>bbcp (无加密)</td><td><code>-w 256M</code>, <code>-S &quot;ssh -c none&quot;</code></td><td>9~11 GB/s</td><td>中</td></tr><tr><td><strong>1Gbps局域网</strong></td><td>bbcp</td><td><code>-w 32M</code>, 无加密</td><td>900~1100 MB/s</td><td>中</td></tr><tr><td><strong>1Gbps局域网</strong></td><td>UDT4</td><td>默认</td><td>800~1000 MB/s</td><td>低</td></tr><tr><td><strong>100Mbps办公网</strong></td><td>bbcp</td><td><code>-w 4M</code></td><td>90~110 MB/s</td><td>中</td></tr><tr><td><strong>跨公网</strong></td><td>GridFTP + 压缩</td><td><code>-p 16</code></td><td>视带宽</td><td>中</td></tr><tr><td><strong>不稳定网络</strong></td><td>GridFTP</td><td>重传机制</td><td>视带宽</td><td>中</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="参数调优建议速度优先">参数调优建议（速度优先）<a href="#参数调优建议速度优先" class="hash-link" aria-label="Direct link to 参数调优建议（速度优先）" title="Direct link to 参数调优建议（速度优先）" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 优质局域网 - UDP极速（推荐）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set peer 192.168.1.100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">send /data/training/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 10Gbps局域网 - 极致速度（推荐）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bbcp -a -f -w 256M \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -S &quot;ssh -c none -x&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/training/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user@nas:/backup/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 1Gbps网络 - 高速传输</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bbcp -a -f -w 32M \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -S &quot;ssh -c none -x&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/training/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user@nas:/backup/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 或 GridFTP（可跨公网）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">globus-url-copy -cd -bb -p 16 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file:///data/training/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ftp://user@nas:2811/backup/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># rclone高速配置（次优选择）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rclone copy src remote:dest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --transfers 16 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --checkers 32 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --bwlimit 0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --buffer-size 256M \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --fast-list \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --disable checksum</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="边传边删策略">边传边删策略<a href="#边传边删策略" class="hash-link" aria-label="Direct link to 边传边删策略" title="Direct link to 边传边删策略" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="方案对比">方案对比<a href="#方案对比" class="hash-link" aria-label="Direct link to 方案对比" title="Direct link to 方案对比" translate="no">​</a></h3>
<table><thead><tr><th>方式</th><th>安全性</th><th>速度影响</th><th>推荐场景</th></tr></thead><tbody><tr><td><code>--remove-source-files</code></td><td>中</td><td>无</td><td>首次完整备份</td></tr><tr><td><code>--delete-during</code></td><td>高</td><td>轻微</td><td>增量同步</td></tr><tr><td>自定义脚本</td><td>高</td><td>自定义</td><td>特殊需求</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="推荐策略">推荐策略<a href="#推荐策略" class="hash-link" aria-label="Direct link to 推荐策略" title="Direct link to 推荐策略" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 首次备份（完整复制，不删）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rclone copy src remote:dest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --transfers 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 后续备份（增量同步，边传边删）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rclone sync src remote:dest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --transfers 8 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --delete-during \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --verbose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 传输完立即删除源文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rclone copy src remote:dest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --transfers 8 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --remove-source-files \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --verbose</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="方案选择建议速度优先">方案选择建议（速度优先）<a href="#方案选择建议速度优先" class="hash-link" aria-label="Direct link to 方案选择建议（速度优先）" title="Direct link to 方案选择建议（速度优先）" translate="no">​</a></h2>
<table><thead><tr><th>场景</th><th>推荐方案</th><th>预期速度</th><th>原因</th></tr></thead><tbody><tr><td><strong>优质局域网</strong></td><td><strong>Tsunami UDP</strong></td><td><strong>10~12 GB/s</strong></td><td>UDP满带宽，无开销</td></tr><tr><td><strong>10Gbps局域网</strong></td><td>bbcp (无加密)</td><td>9~11 GB/s</td><td>TCP稳定兼容</td></tr><tr><td><strong>1Gbps网络</strong></td><td>bbcp</td><td>900~1100 MB/s</td><td>低CPU，低延迟</td></tr><tr><td><strong>HPC环境</strong></td><td>UDT4</td><td>8~10 GB/s</td><td>专为HPC设计</td></tr><tr><td><strong>需要加密</strong></td><td>bbcp + SSH</td><td>7~9 GB/s</td><td>可选加密</td></tr><tr><td><strong>跨公网</strong></td><td>GridFTP</td><td>视带宽</td><td>可穿越公网</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="最终推荐配置速度优先">最终推荐配置（速度优先）<a href="#最终推荐配置速度优先" class="hash-link" aria-label="Direct link to 最终推荐配置（速度优先）" title="Direct link to 最终推荐配置（速度优先）" translate="no">​</a></h3>
<p>对于50人规模、<strong>只关心传输速度</strong>的训练数据备份：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 优质局域网（推荐）- Tsunami UDP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set peer 192.168.1.100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set port 46200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">send /data/training/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 或 bbcp（更稳定的替代方案）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bbcp -a -f -w 256M \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -S &quot;ssh -c none -x&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/training/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user@nas:/backup/training/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 使用完整脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-/scripts/backup-bbcp-fast.sh</span><br></span></code></pre></div></div>
<p><strong>预期性能（10Gbps优质局域网）：</strong></p>
<ul>
<li class=""><strong>Tsunami UDP: 10~12 GB/s</strong>（比TCP快10~20%）</li>
<li class="">bbcp: 9~11 GB/s</li>
<li class="">100GB数据集：Tsunami约8秒，bbcp约10秒</li>
<li class="">边传边删：无额外开销</li>
<li class="">CPU占用：&lt;5%</li>
</ul>
<p><strong>预期性能（1Gbps局域网）：</strong></p>
<ul>
<li class="">bbcp/UDT4: 900~1100 MB/s</li>
<li class="">100GB数据集：约100秒</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="udp极速方案tsunami-udp-protocol">UDP极速方案：Tsunami UDP Protocol<a href="#udp极速方案tsunami-udp-protocol" class="hash-link" aria-label="Direct link to UDP极速方案：Tsunami UDP Protocol" title="Direct link to UDP极速方案：Tsunami UDP Protocol" translate="no">​</a></h2>
<p><strong>局域网网络质量好时，UDP比TCP更快！</strong></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="为什么udp在好网络下更快">为什么UDP在好网络下更快？<a href="#为什么udp在好网络下更快" class="hash-link" aria-label="Direct link to 为什么UDP在好网络下更快？" title="Direct link to 为什么UDP在好网络下更快？" translate="no">​</a></h3>
<table><thead><tr><th>特性</th><th>TCP</th><th>UDP</th></tr></thead><tbody><tr><td>拥塞控制</td><td>保守降速</td><td>无，激进发送</td></tr><tr><td>重传机制</td><td>等待超时</td><td>应用层控制</td></tr><tr><td>头部开销</td><td>20~60字节</td><td>8字节</td></tr><tr><td>带宽利用</td><td>受限于窗口</td><td>尽可能占满</td></tr><tr><td>丢包处理</td><td>阻塞等待</td><td>跳过/快速恢复</td></tr></tbody></table>
<p><strong>结论</strong>：在零丢包的局域网环境中，UDP可以达到<strong>理论线速</strong>（接近100%带宽利用率）。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="参考资料与研究佐证">参考资料与研究佐证<a href="#参考资料与研究佐证" class="hash-link" aria-label="Direct link to 参考资料与研究佐证" title="Direct link to 参考资料与研究佐证" translate="no">​</a></h3>
<p>本文档中UDP协议的性能数据基于以下权威研究和实践验证：</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-tsunami-udp-protocol-官方资料">1. Tsunami UDP Protocol 官方资料<a href="#1-tsunami-udp-protocol-官方资料" class="hash-link" aria-label="Direct link to 1. Tsunami UDP Protocol 官方资料" title="Direct link to 1. Tsunami UDP Protocol 官方资料" translate="no">​</a></h4>
<p><strong>来源</strong>: <a href="https://tsunami-udp.sourceforge.net/" target="_blank" rel="noopener noreferrer" class="">Tsunami UDP Protocol - SourceForge</a></p>
<blockquote>
<p>Tsunami UDP Protocol: A fast user-space file transfer protocol that uses TCP control and UDP data for transfer over very high speed long distance networks (≥ 1 Gbps and even 10 GE), designed to provide more throughput than possible with TCP over the same networks.</p>
</blockquote>
<ul>
<li class="">专为1Gbps+和10GE网络设计</li>
<li class="">在高速网络中提供比TCP更高的吞吐量</li>
<li class="">开源项目，由Aalto University和Metsähovi Radio Observatory维护</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-udt协议学术研究">2. UDT协议学术研究<a href="#2-udt协议学术研究" class="hash-link" aria-label="Direct link to 2. UDT协议学术研究" title="Direct link to 2. UDT协议学术研究" translate="no">​</a></h4>
<p><strong>来源</strong>: <a href="https://papers.rgrossman.com/journal-035.pdf" target="_blank" rel="noopener noreferrer" class="">UDT: UDP-based Data Transfer for High-Speed Wide Area Networks</a> - Yunhong Gu &amp; Robert L Grossman, University of Illinois Chicago</p>
<p><strong>核心结论</strong>:</p>
<blockquote>
<p>UDT was designed to effectively utilize the rapidly emerging high-speed wide area optical networks. It is built on top of UDP with reliability control and congestion control.</p>
</blockquote>
<ul>
<li class="">在10Gbps网络中，UDT相比TCP有显著性能优势</li>
<li class="">专为高速广域光网络设计</li>
<li class="">已被广泛应用于科学计算领域</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-tcp在10gbps网络的局限性研究">3. TCP在10Gbps网络的局限性研究<a href="#3-tcp在10gbps网络的局限性研究" class="hash-link" aria-label="Direct link to 3. TCP在10Gbps网络的局限性研究" title="Direct link to 3. TCP在10Gbps网络的局限性研究" translate="no">​</a></h4>
<p><strong>来源</strong>: <a href="https://www.sciencedirect.com/science/article/abs/pii/S1389128609002941" target="_blank" rel="noopener noreferrer" class="">Measurement and performance issues of transport protocols over 10 Gbps high-speed optical networks</a> - Computer Networks Journal, 2010</p>
<p><strong>关键发现</strong>:</p>
<blockquote>
<p>The performance of TCP variants is highly impacted by the Linux TCP/IP stack tuning. Overall performance of each TCP variant is dependent on different network environments.</p>
</blockquote>
<ul>
<li class="">TCP性能受Linux TCP/IP栈调优影响极大</li>
<li class="">在高带宽网络中需要大量参数优化</li>
<li class="">UDP方案在此类环境中表现更稳定</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-aws生产环境实践">4. AWS生产环境实践<a href="#4-aws生产环境实践" class="hash-link" aria-label="Direct link to 4. AWS生产环境实践" title="Direct link to 4. AWS生产环境实践" translate="no">​</a></h4>
<p><strong>来源</strong>: <a href="https://aws.amazon.com/blogs/database/accelerate-large-database-migrations-to-amazon-rds-custom-oracle-using-tsunami-udp" target="_blank" rel="noopener noreferrer" class="">Accelerate large database migrations using Tsunami UDP</a> - AWS Database Blog, 2023</p>
<blockquote>
<p>For medium and large databases, such as those ranging from hundreds of gigabytes to 5 terabytes, speed of data transfer matters.</p>
</blockquote>
<ul>
<li class="">AWS官方推荐使用Tsunami UDP进行大规模数据传输</li>
<li class="">适用于数百GB到5TB的数据库迁移</li>
<li class="">可显著减少迁移停机时间</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-性能对比总结">5. 性能对比总结<a href="#5-性能对比总结" class="hash-link" aria-label="Direct link to 5. 性能对比总结" title="Direct link to 5. 性能对比总结" translate="no">​</a></h4>
<table><thead><tr><th>研究/来源</th><th>结论</th><th>验证场景</th></tr></thead><tbody><tr><td>Tsunami官方</td><td>UDP比TCP提供更高吞吐量</td><td>≥1Gbps网络</td></tr><tr><td>UDT论文</td><td>UDP有效利用高速光网络</td><td>10Gbps WAN</td></tr><tr><td>ScienceDirect</td><td>TCP性能受网络环境制约</td><td>10Gbps optical</td></tr><tr><td>AWS实践</td><td>Tsunami适合大规模数据迁移</td><td>生产环境</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="tsunami-udp-protocol">Tsunami UDP Protocol<a href="#tsunami-udp-protocol" class="hash-link" aria-label="Direct link to Tsunami UDP Protocol" title="Direct link to Tsunami UDP Protocol" translate="no">​</a></h3>
<p>开源UDP文件传输工具，专为大文件高速传输设计：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt install tsunami-udp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 接收端（先启动）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami&gt; set port 46200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami&gt; set peer 0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami&gt; receive /backup/dataset.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 发送端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami&gt; set port 46200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami&gt; set peer 192.168.1.100  # 接收端IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami&gt; send /data/training/dataset.tar.gz</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="udt-udp-based-data-transfer">UDT (UDP-based Data Transfer)<a href="#udt-udp-based-data-transfer" class="hash-link" aria-label="Direct link to UDT (UDP-based Data Transfer)" title="Direct link to UDT (UDP-based Data Transfer)" translate="no">​</a></h3>
<p>高性能UDP传输库，用于科学计算和HPC环境：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt install udt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 使用udtftp传输</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">udtftp --send --host 192.168.1.100 --port 46200 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /data/training/dataset.tar.gz</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="udp方案对比">UDP方案对比<a href="#udp方案对比" class="hash-link" aria-label="Direct link to UDP方案对比" title="Direct link to UDP方案对比" translate="no">​</a></h3>
<table><thead><tr><th>技术</th><th>协议</th><th>速度</th><th>丢包处理</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Tsunami UDP</strong></td><td>UDP</td><td><strong>10~12 GB/s</strong></td><td>跳过</td><td>局域网高速传输</td></tr><tr><td><strong>Namida</strong></td><td>UDP (Rust)</td><td><strong>10~12 GB/s</strong></td><td>跳过/重传</td><td>现代化替代方案</td></tr><tr><td><strong>UDT4</strong></td><td>UDP</td><td>8~10 GB/s</td><td>重传</td><td>科学计算，HPC</td></tr><tr><td><strong>bbcp (TCP)</strong></td><td>TCP</td><td>9~11 GB/s</td><td>重传</td><td>通用，兼容性优先</td></tr><tr><td><strong>GridFTP</strong></td><td>TCP</td><td>8~9 GB/s</td><td>重传</td><td>需要跨公网时</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="现代化实现namida推荐">现代化实现：Namida（推荐）<a href="#现代化实现namida推荐" class="hash-link" aria-label="Direct link to 现代化实现：Namida（推荐）" title="Direct link to 现代化实现：Namida（推荐）" translate="no">​</a></h3>
<p><strong>Namida</strong> 是 Tsunami UDP 的现代化 Rust 重写版本，推荐用于新部署：</p>
<p><strong>来源</strong>: <a href="https://github.com/meew0/namida" target="_blank" rel="noopener noreferrer" class="">meew0/namida - GitHub</a></p>
<blockquote>
<p>namida is a tool for fast file downloads over high-latency and/or unreliable networks. It uses UDP for bulk data transmission, together with a minimal TCP control stream to mediate retransmission of lost data.</p>
</blockquote>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="namida-vs-tsunami-对比">Namida vs Tsunami 对比<a href="#namida-vs-tsunami-对比" class="hash-link" aria-label="Direct link to Namida vs Tsunami 对比" title="Direct link to Namida vs Tsunami 对比" translate="no">​</a></h4>
<table><thead><tr><th>特性</th><th>Tsunami (原版)</th><th>Namida (现代化)</th></tr></thead><tbody><tr><td>语言</td><td>C</td><td>Rust</td></tr><tr><td>最后更新</td><td>2009</td><td>活跃维护</td></tr><tr><td>CLI方式</td><td>交互式控制台</td><td>单命令完成</td></tr><tr><td>NAT穿透</td><td>❌</td><td>✅ 默认支持</td></tr><tr><td>加密</td><td>可选</td><td>✅ 默认加密 (snow)</td></tr><tr><td>断点续传</td><td>❌</td><td>✅ 自动支持</td></tr><tr><td>安装</td><td>源码编译</td><td>Rust cargo</td></tr></tbody></table>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="namida-安装与使用">Namida 安装与使用<a href="#namida-安装与使用" class="hash-link" aria-label="Direct link to Namida 安装与使用" title="Direct link to Namida 安装与使用" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 安装 Rust（如果未安装）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl --proto &#x27;=https&#x27; --tlsv1.2 -sSf https://sh.rustup.rs | sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source ~/.cargo/env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 安装 namida</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cargo install --git https://github.com/meew0/namida.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 或源码编译</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/meew0/namida.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd namida</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cargo build --release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 启动服务端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namida serve /data/training/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 客户端下载（单文件）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namida get --server 192.168.1.100:5266 dataset.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 客户端下载（全部文件）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namida get --server 192.168.1.100:5266 --all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 限制传输速率（避免占满带宽）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namida get --server 192.168.1.100:5266 --rate 100M dataset.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看服务端文件列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namida dir --server 192.168.1.100:5266</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="namida-关键参数">Namida 关键参数<a href="#namida-关键参数" class="hash-link" aria-label="Direct link to Namida 关键参数" title="Direct link to Namida 关键参数" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 常用选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--server, -s       # 指定服务端地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--port, -p         # 指定端口（默认5266）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--rate, -r         # 限制传输速率（如 100M, 1G）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--all, -a          # 下载所有文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output, -o       # 输出文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--verbose, -v      # 详细输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--help, -h         # 帮助信息</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="namida-完整备份脚本">Namida 完整备份脚本<a href="#namida-完整备份脚本" class="hash-link" aria-label="Direct link to Namida 完整备份脚本" title="Direct link to Namida 完整备份脚本" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ~/scripts/backup-namida.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Namida 现代化UDP备份脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -euo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_HOST=&quot;192.168.1.100&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_PORT=&quot;5266&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_PATH=&quot;/backup/${USER}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SOURCE_PATHS=(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/training&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/models&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/experiments&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RATE_LIMIT=&quot;5G&quot;  # 根据网络带宽调整</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_DIR=&quot;${HOME}/.local/share/backup/logs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)] [namida] $*&quot; | tee -a &quot;${LOG_DIR}/namida_$(date +%Y%m%d).log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run_backup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local src=&quot;$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local filename=$(basename &quot;${src}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ ! -d &quot;${src}&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;跳过: ${src} 不存在&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;备份: ${src} -&gt; ${NAS_HOST}:${NAS_PATH}/${filename}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Namida 传输（服务端需提前启动 namida serve）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namida get \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --server &quot;${NAS_HOST}:${NAS_PORT}&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --rate &quot;${RATE_LIMIT}&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --output &quot;${NAS_PATH}/${filename}&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --verbose \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;${filename}&quot; 2&gt;&amp;1 | while read line; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log &quot;  $line&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ ${PIPESTATUS[0]} -eq 0 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;完成: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 删除源文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        find &quot;${src}&quot; -type f -delete 2&gt;/dev/null || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;错误: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p &quot;${LOG_DIR}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== Namida备份开始 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;目标: ${NAS_HOST}:${NAS_PORT}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;速率限制: ${RATE_LIMIT}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for path in &quot;${SOURCE_PATHS[@]}&quot;; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        run_backup &quot;${path}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== Namida备份完成 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main &quot;$@&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="namida-systemd-服务">Namida Systemd 服务<a href="#namida-systemd-服务" class="hash-link" aria-label="Direct link to Namida Systemd 服务" title="Direct link to Namida Systemd 服务" translate="no">​</a></h4>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ~/.config/systemd/user/namida-serve.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=Namida 文件传输服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After=network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Wants=network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type=simple</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=%h/.cargo/bin/namida serve /data/training/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Environment=&quot;NAMIDA_PORT=5266&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StandardOutput=append:%h/.local/share/backup/logs/namida.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StandardError=append:%h/.local/share/backup/logs/namida.error.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Restart=on-failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestartSec=10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=default.target</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 启用服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl --user daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl --user enable namida-serve.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl --user start namida-serve.service</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="namida-选择建议">Namida 选择建议<a href="#namida-选择建议" class="hash-link" aria-label="Direct link to Namida 选择建议" title="Direct link to Namida 选择建议" translate="no">​</a></h4>
<p><strong>推荐使用 Namida 的场景：</strong></p>
<ul>
<li class="">✅ 新部署首选（现代化，维护活跃）</li>
<li class="">✅ 需要NAT穿透（客户端在NAT后）</li>
<li class="">✅ 需要加密传输</li>
<li class="">✅ 需要断点续传</li>
<li class="">✅ 追求代码安全（Rust内存安全）</li>
</ul>
<p><strong>继续使用 Tsunami 的场景：</strong></p>
<ul>
<li class="">⚠️ 已有Tsunami部署，迁移成本高</li>
<li class="">⚠️ 需要VLBI专用硬件支持</li>
<li class="">⚠️ 对二进制大小敏感（Rust编译产物较大）</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="tsunami-完整脚本">Tsunami 完整脚本<a href="#tsunami-完整脚本" class="hash-link" aria-label="Direct link to Tsunami 完整脚本" title="Direct link to Tsunami 完整脚本" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -/scripts/backup-tsunami.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tsunami UDP 极速备份（局域网专用）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -euo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_IP=&quot;192.168.1.100&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_PATH=&quot;/backup/${USER}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SOURCE_PATHS=(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/training&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/models&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/experiments&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PORT=46200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_DIR=&quot;${HOME}/.local/share/backup/logs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)] $*&quot; | tee -a &quot;${LOG_DIR}/tsunami_$(date +%Y%m%d).log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run_backup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local src=&quot;$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local dst=&quot;${NAS_IP}:${NAS_PATH}$(dirname ${src})&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;备份: ${src} -&gt; ${dst}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Tsunami UDP 传输</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 注意：需要在接收端先启动 tsunami receive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tsunami &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set port ${PORT}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set peer ${NAS_IP}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">send ${src}/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ $? -eq 0 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;完成: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;删除源文件: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        find &quot;${src}&quot; -type f -delete 2&gt;/dev/null || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;错误: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p &quot;${LOG_DIR}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== Tsunami UDP 极速备份开始 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for path in &quot;${SOURCE_PATHS[@]}&quot;; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if [ -d &quot;${path}&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            run_backup &quot;${path}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== Tsunami UDP 备份完成 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main &quot;$@&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="udp方案使用建议">UDP方案使用建议<a href="#udp方案使用建议" class="hash-link" aria-label="Direct link to UDP方案使用建议" title="Direct link to UDP方案使用建议" translate="no">​</a></h3>
<p><strong>推荐使用场景：</strong></p>
<ul>
<li class="">✅ 10Gbps+ 局域网，零丢包</li>
<li class="">✅ 大文件连续传输（&gt;1GB）</li>
<li class="">✅ 训练数据批量备份</li>
<li class="">✅ 对安全性要求低（内网）</li>
</ul>
<p><strong>不推荐使用场景：</strong></p>
<ul>
<li class="">❌ 网络质量不稳定（有丢包）</li>
<li class="">❌ 跨公网传输</li>
<li class="">❌ 数据完整性要求100%</li>
<li class="">❌ 需要穿越防火墙</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="综合推荐速度优先">综合推荐（速度优先）<a href="#综合推荐速度优先" class="hash-link" aria-label="Direct link to 综合推荐（速度优先）" title="Direct link to 综合推荐（速度优先）" translate="no">​</a></h3>
<table><thead><tr><th>网络环境</th><th>推荐方案</th><th>预期速度</th><th>原因</th></tr></thead><tbody><tr><td><strong>优质局域网</strong></td><td>Tsunami UDP</td><td><strong>10~12 GB/s</strong></td><td>UDP满带宽</td></tr><tr><td><strong>10Gbps局域网</strong></td><td>bbcp (无加密)</td><td>9~11 GB/s</td><td>TCP稳定</td></tr><tr><td><strong>1Gbps局域网</strong></td><td>bbcp</td><td>900~1100 MB/s</td><td>低CPU</td></tr><tr><td><strong>混合环境</strong></td><td>GridFTP</td><td>8~9 GB/s</td><td>可跨公网</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="详细部署落地方案">详细部署落地方案<a href="#详细部署落地方案" class="hash-link" aria-label="Direct link to 详细部署落地方案" title="Direct link to 详细部署落地方案" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="一环境准备">一、环境准备<a href="#一环境准备" class="hash-link" aria-label="Direct link to 一、环境准备" title="Direct link to 一、环境准备" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="11-网络环境要求">1.1 网络环境要求<a href="#11-网络环境要求" class="hash-link" aria-label="Direct link to 1.1 网络环境要求" title="Direct link to 1.1 网络环境要求" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 检查网络带宽</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iperf3 -c 192.168.1.100 -t 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 检查丢包率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iperf3 -c 192.168.1.100 -u -b 10G -t 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 检查MTU</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping -M do -s 8972 192.168.1.100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 推荐网络配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># - 10Gbps+ 网卡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># - MTU 9000 (Jumbo Frame)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># - 零丢包或 &lt;0.01% 丢包率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># - 延迟 &lt;1ms</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="12-系统参数优化">1.2 系统参数优化<a href="#12-系统参数优化" class="hash-link" aria-label="Direct link to 1.2 系统参数优化" title="Direct link to 1.2 系统参数优化" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># /etc/sysctl.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 网络缓冲区调优</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.rmem_max = 536870912</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.wmem_max = 536870912</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.rmem_default = 1048576</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.wmem_default = 1048576</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_rmem = 4096 87380 536870912</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_wmem = 4096 65536 536870912</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TCP窗口扩大</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_window_scaling = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 禁用TCP延迟确认</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_no_metrics_save = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_low_latency = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># UDP缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.netdev_max_backlog = 50000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 应用配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo sysctl -p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># /etc/security/limits.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*    soft    nofile    1000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*    hard    nofile    1000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*    soft    memlock    unlimited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*    hard    memlock    unlimited</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="13-网卡jumbo-frame配置">1.3 网卡Jumbo Frame配置<a href="#13-网卡jumbo-frame配置" class="hash-link" aria-label="Direct link to 1.3 网卡Jumbo Frame配置" title="Direct link to 1.3 网卡Jumbo Frame配置" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 检查当前MTU</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip link show eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 设置MTU 9000（需要交换机支持Jumbo Frame）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo ip link set eth0 mtu 9000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 持久化配置 /etc/network/interfaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iface eth0 inet static</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">address 192.168.1.50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">netmask 255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gateway 192.168.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mtu 9000</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="二安装部署">二、安装部署<a href="#二安装部署" class="hash-link" aria-label="Direct link to 二、安装部署" title="Direct link to 二、安装部署" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="21-bbcp-安装所有节点">2.1 bbcp 安装（所有节点）<a href="#21-bbcp-安装所有节点" class="hash-link" aria-label="Direct link to 2.1 bbcp 安装（所有节点）" title="Direct link to 2.1 bbcp 安装（所有节点）" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 方法1: apt安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt install -y bbcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 方法2: 源码编译（最新版本）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/ltp/bbcp.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd bbcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make -j$(nproc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo make install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 验证安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bbcp --version</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="22-tsunami-udp-安装所有节点">2.2 Tsunami UDP 安装（所有节点）<a href="#22-tsunami-udp-安装所有节点" class="hash-link" aria-label="Direct link to 2.2 Tsunami UDP 安装（所有节点）" title="Direct link to 2.2 Tsunami UDP 安装（所有节点）" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 下载编译</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget https://github.com/kthe/tsunami-udp/archive/refs/heads/master.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unzip master.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd tsunami-udp-master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make -j$(ncpus)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 安装到系统</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo cp tsunami /usr/local/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo chmod +x /usr/local/bin/tsunami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo mkdir -p /etc/tsunami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo cp tsunami.cfg /etc/tsunami/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 验证安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsunami --help</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="23-gridftp-安装nas服务器">2.3 GridFTP 安装（NAS服务器）<a href="#23-gridftp-安装nas服务器" class="hash-link" aria-label="Direct link to 2.3 GridFTP 安装（NAS服务器）" title="Direct link to 2.3 GridFTP 安装（NAS服务器）" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Globus Toolkit 安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt install -y globus-toolkit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 或使用Docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -d --name globus-endpoint \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p 2811:2811 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  globusonline/globus-connect-server</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="三配置部署">三、配置部署<a href="#三配置部署" class="hash-link" aria-label="Direct link to 三、配置部署" title="Direct link to 三、配置部署" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="31-ssh免密登录bbcp用">3.1 SSH免密登录（bbcp用）<a href="#31-ssh免密登录bbcp用" class="hash-link" aria-label="Direct link to 3.1 SSH免密登录（bbcp用）" title="Direct link to 3.1 SSH免密登录（bbcp用）" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 生成专用密钥（无加密）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh-keygen -t ed25519 -f -/.ssh/id_bbcp -N &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh-keygen -t ed25519 -f -/.ssh/id_bbcp -p &quot;&quot; -P &quot;&quot; -f -/.ssh/id_bbcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 配置SSH（禁用加密加速）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt;&gt; -/.ssh/config &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host nas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HostName 192.168.1.100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    User backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IdentityFile -/.ssh/id_bbcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PasswordAuthentication no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ciphers none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MACs none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Compression no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BatchMode yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StrictHostKeyChecking no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 分发公钥到NAS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh-copy-id -i -/.ssh/id_bbcp.pub backup@192.168.1.100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 测试连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh -c none backup@192.168.1.100 &quot;echo &#x27;OK&#x27;&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="32-bbcp-完整部署脚本">3.2 bbcp 完整部署脚本<a href="#32-bbcp-完整部署脚本" class="hash-link" aria-label="Direct link to 3.2 bbcp 完整部署脚本" title="Direct link to 3.2 bbcp 完整部署脚本" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -/scripts/deploy-bbcp.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># bbcp 一键部署脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -euo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SCRIPT_DIR=&quot;$(cd &quot;$(dirname &quot;${BASH_SOURCE[0]}&quot;)&quot; &amp;&amp; pwd)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_HOST=&quot;192.168.1.100&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_USER=&quot;backup&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_PATH=&quot;/backup&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOCAL_USER=&quot;${USER}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;=== bbcp 部署脚本 ===&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;目标: ${NAS_USER}@${NAS_HOST}:${NAS_PATH}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 1. 安装bbcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;[1/5] 安装bbcp...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ! command -v bbcp &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt install -y bbcp || {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cd /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        git clone https://github.com/ltp/bbcp.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cd bbcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        make -j$(nproc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sudo make install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;  bbcp版本: $(bbcp --version 2&gt;&amp;1 | head -1)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2. 生成SSH密钥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;[2/5] 配置SSH密钥...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p -/.ssh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod 700 -/.ssh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ ! -f -/.ssh/id_bbcp ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssh-keygen -t ed25519 -f -/.ssh/id_bbcp -N &quot;&quot; -q</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod 600 -/.ssh/id_bbcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3. 配置SSH客户端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ! grep -q &quot;Ciphers none&quot; -/.ssh/config 2&gt;/dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cat &gt;&gt; -/.ssh/config &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host ${NAS_HOST}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HostName ${NAS_HOST}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    User ${NAS_USER}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IdentityFile -/.ssh/id_bbcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ciphers none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MACs none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Compression no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BatchMode yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StrictHostKeyChecking no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 4. 分发公钥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;[3/5] 分发公钥到NAS...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh-copy-id -i -/.ssh/id_bbcp.pub ${NAS_USER}@${NAS_HOST} || {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;  警告: 公钥已存在或分发失败&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 5. 创建目录结构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;[4/5] 创建备份目录...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh ${NAS_USER}@${NAS_HOST} &quot;mkdir -p ${NAS_PATH}/${LOCAL_USER}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;[5/5] 测试连接...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ssh -c none ${NAS_USER}@${NAS_HOST} &quot;echo &#x27;OK&#x27;&quot; | grep -q &quot;OK&quot;; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;  ✓ 连接成功&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;  ✗ 连接失败，请检查网络或认证&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;=== 部署完成 ===&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;可用命令:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;  bbcp -a -f -w 256M -S &#x27;ssh -c none -x&#x27; /data/file ${NAS_USER}@${NAS_HOST}:${NAS_PATH}/&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="33-tsunami-udp-部署脚本">3.3 Tsunami UDP 部署脚本<a href="#33-tsunami-udp-部署脚本" class="hash-link" aria-label="Direct link to 3.3 Tsunami UDP 部署脚本" title="Direct link to 3.3 Tsunami UDP 部署脚本" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -/scripts/deploy-tsunami.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tsunami UDP 一键部署脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -euo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_HOST=&quot;192.168.1.100&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_USER=&quot;backup&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_PATH=&quot;/backup/$(whoami)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSTALL_DIR=&quot;/usr/local/bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;=== Tsunami UDP 部署脚本 ===&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 1. 检查依赖</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;[1/4] 检查依赖...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for cmd in make g++; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ! command -v $cmd &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;  安装 $cmd...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sudo apt install -y build-essential</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        break</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2. 安装Tsunami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;[2/4] 安装Tsunami...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ ! -f ${INSTALL_DIR}/tsunami ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cd /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rm -rf tsunami-udp-master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wget -q https://github.com/kthe/tsunami-udp/archive/refs/heads/master.zip -O tsunami.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unzip -q tsunami.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cd tsunami-udp-master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    make -j$(nproc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo cp tsunami ${INSTALL_DIR}/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo chmod +x ${INSTALL_DIR}/tsunami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;  Tsunami版本: $(${INSTALL_DIR}/tsunami --help 2&gt;&amp;1 | head -1)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3. 创建配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;[3/4] 创建配置...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo mkdir -p /etc/tsunami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo tee /etc/tsunami/tsunami.cfg &gt; /dev/null &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tsunami UDP 配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peer_ip             ${NAS_HOST}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peer_port           46200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">socket_buffer_size  16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">packet_size         1400</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">send_buffer_size    16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">receive_buffer_size 16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">max_pending_packets 10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 4. 远程部署（接收端）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;[4/4] 远程部署接收端...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh ${NAS_USER}@${NAS_HOST} &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p ${NAS_PATH}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p -/.tsunami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cat &gt; -/.tsunami/tsunami.cfg &lt;&lt;CONFIG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peer_ip             0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peer_port           46200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">socket_buffer_size  16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">packet_size         1400</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">send_buffer_size    16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">receive_buffer_size 16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">max_pending_packets 10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONFIG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;=== 部署完成 ===&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;使用方法:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;  接收端: tsunami -&gt; receive /backup/file&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;  发送端: tsunami -&gt; set peer ${NAS_HOST} -&gt; send /data/file&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="四systemd-服务配置">四、Systemd 服务配置<a href="#四systemd-服务配置" class="hash-link" aria-label="Direct link to 四、Systemd 服务配置" title="Direct link to 四、Systemd 服务配置" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="41-bbcp-定时备份服务">4.1 bbcp 定时备份服务<a href="#41-bbcp-定时备份服务" class="hash-link" aria-label="Direct link to 4.1 bbcp 定时备份服务" title="Direct link to 4.1 bbcp 定时备份服务" translate="no">​</a></h4>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># -/.config/systemd/user/backup-bbcp.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=训练数据备份 (bbcp极速版)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After=network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Wants=network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type=oneshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=%h/scripts/backup-bbcp-fast.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Environment=&quot;FORCE_BACKUP=false&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Environment=&quot;TCP_WINDOW=256M&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Environment=&quot;PARALLEL_STREAMS=8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StandardOutput=append:%h/.local/share/backup/logs/backup.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StandardError=append:%h/.local/share/backup/logs/backup.error.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=default.target</span><br></span></code></pre></div></div>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># -/.config/systemd/user/backup-bbcp.timer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=每天22:00自动备份训练数据 (bbcp极速版)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Timer]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OnCalendar=*-*-* 22:00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Persistent=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RandomizedDelaySec=5min</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AccuracySec=1min</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=timers.target</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 启用服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl --user daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl --user enable backup-bbcp.timer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl --user start backup-bbcp.timer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl --user list-timers</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="42-tsunami-udp-接收端常驻服务">4.2 Tsunami UDP 接收端常驻服务<a href="#42-tsunami-udp-接收端常驻服务" class="hash-link" aria-label="Direct link to 4.2 Tsunami UDP 接收端常驻服务" title="Direct link to 4.2 Tsunami UDP 接收端常驻服务" translate="no">​</a></h4>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># /etc/systemd/system/tsunami-receive.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=Tsunami UDP 接收服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After=network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type=simple</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User=backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=/usr/local/bin/tsunami receive /backup/%u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StandardOutput=journal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StandardError=journal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Restart=always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestartSec=10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=multi-user.target</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 部署接收端服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo cp tsunami-receive.service /etc/systemd/system/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl enable tsunami-receive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl start tsunami-receive</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="五备份脚本">五、备份脚本<a href="#五备份脚本" class="hash-link" aria-label="Direct link to 五、备份脚本" title="Direct link to 五、备份脚本" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="51-bbcp-完整备份脚本">5.1 bbcp 完整备份脚本<a href="#51-bbcp-完整备份脚本" class="hash-link" aria-label="Direct link to 5.1 bbcp 完整备份脚本" title="Direct link to 5.1 bbcp 完整备份脚本" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -/scripts/backup-bbcp.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 训练数据备份 - bbcp极速版</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -euo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_HOST=&quot;${NAS_HOST:-192.168.1.100}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_USER=&quot;${NAS_USER:-backup}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_PATH=&quot;${NAS_PATH:-/backup}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TCP_WINDOW=&quot;${TCP_WINDOW:-256M}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARALLEL_STREAMS=&quot;${PARALLEL_STREAMS:-8}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SOURCE_PATHS=(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/training&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/models&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/experiments&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_DIR=&quot;${HOME}/.local/share/backup/logs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_FILE=&quot;${LOG_DIR}/bbcp_$(date +%Y%m%d).log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)] [bbcp] $*&quot; | tee -a &quot;${LOG_FILE}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">check_nas() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ! ssh -c none -o BatchMode=yes ${NAS_USER}@${NAS_HOST} &quot;test -w ${NAS_PATH}&quot; 2&gt;/dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;错误: 无法访问NAS ${NAS_USER}@${NAS_HOST}:${NAS_PATH}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run_backup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local src=&quot;$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local dst=&quot;${NAS_USER}@${NAS_HOST}:${NAS_PATH}$(dirname ${src})&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ ! -d &quot;${src}&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;跳过: ${src} 不存在&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local file_count=$(find &quot;${src}&quot; -type f | wc -l)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local total_size=$(du -sb &quot;${src}&quot; | cut -f1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;开始备份: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;  文件数: ${file_count}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;  总大小: $(numfmt --to=iec ${total_size})&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # bbcp极速传输</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bbcp -a -f -w &quot;${TCP_WINDOW}&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -S &quot;ssh -c none -x -o Compression=no -o BatchMode=yes&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --ignore-permissions \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --verbose \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;${src}/&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;${dst}/&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        2&gt;&amp;1 | while read line; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log &quot;  $line&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ ${PIPESTATUS[0]} -eq 0 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;完成: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;删除源文件...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        find &quot;${src}&quot; -type f -delete 2&gt;/dev/null || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;错误: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p &quot;${LOG_DIR}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== bbcp备份开始 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;目标: ${NAS_USER}@${NAS_HOST}:${NAS_PATH}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;TCP窗口: ${TCP_WINDOW}, 并行流: ${PARALLEL_STREAMS}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check_nas || exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for path in &quot;${SOURCE_PATHS[@]}&quot;; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        run_backup &quot;${path}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== bbcp备份完成 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 输出统计</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssh ${NAS_USER}@${NAS_HOST} &quot;du -sh ${NAS_PATH}/*&quot; | while read size dir; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;  ${size} ${dir}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main &quot;$@&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="52-tsunami-udp-备份脚本">5.2 Tsunami UDP 备份脚本<a href="#52-tsunami-udp-备份脚本" class="hash-link" aria-label="Direct link to 5.2 Tsunami UDP 备份脚本" title="Direct link to 5.2 Tsunami UDP 备份脚本" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -/scripts/backup-tsunami.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 训练数据备份 - Tsunami UDP极速版</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -euo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_HOST=&quot;${NAS_HOST:-192.168.1.100}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_PORT=&quot;${NAS_PORT:-46200}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_PATH=&quot;${NAS_PATH:-/backup}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SOURCE_PATHS=(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/training&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/data/models&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_DIR=&quot;${HOME}/.local/share/backup/logs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_FILE=&quot;${LOG_DIR}/tsunami_$(date +%Y%m%d).log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)] [tsunami] $*&quot; | tee -a &quot;${LOG_FILE}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run_backup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local src=&quot;$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ ! -d &quot;${src}&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;跳过: ${src} 不存在&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;开始备份: ${src} -&gt; ${NAS_HOST}:${NAS_PATH}$(dirname ${src})&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Tsunami交互式命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;set peer ${NAS_HOST}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;set port ${NAS_PORT}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;set buffer 16777216&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;send ${src}/*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;quit&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } | timeout 86400 tsunami 2&gt;&amp;1 | while read line; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;  $line&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 删除源文件（确认传输成功）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ ${PIPESTATUS[0]} -eq 0 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;完成: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;删除源文件...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        find &quot;${src}&quot; -type f -delete 2&gt;/dev/null || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log &quot;错误: ${src}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p &quot;${LOG_DIR}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== Tsunami UDP备份开始 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;目标: ${NAS_HOST}:${NAS_PORT}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for path in &quot;${SOURCE_PATHS[@]}&quot;; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        run_backup &quot;${path}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log &quot;========== Tsunami UDP备份完成 ==========&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main &quot;$@&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="六监控与告警">六、监控与告警<a href="#六监控与告警" class="hash-link" aria-label="Direct link to 六、监控与告警" title="Direct link to 六、监控与告警" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="61-传输监控脚本">6.1 传输监控脚本<a href="#61-传输监控脚本" class="hash-link" aria-label="Direct link to 6.1 传输监控脚本" title="Direct link to 6.1 传输监控脚本" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -/scripts/monitor-transfer.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 传输监控与告警</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_DIR=&quot;${HOME}/.local/share/backup/logs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ALERT_EMAIL=&quot;admin@stars-labs.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS_HOST=&quot;192.168.1.100&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">check_recent_backup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local last_log=$(ls -t ${LOG_DIR}/bbcp_*.log 2&gt;/dev/null | head -1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ -z &quot;$last_log&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;无备份记录&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local last_time=$(stat -c %Y &quot;$last_log&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local now=$(date +%s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local diff=$((now - last_time))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ $diff -gt 86400 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;警告: 超过24小时无备份 (${diff}s)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;正常: 最后备份 ${diff}s 前&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">check_nas_space() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local space=$(ssh backup@${NAS_HOST} &quot;df -h ${NAS_PATH} | tail -1&quot; 2&gt;/dev/null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;$space&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">check_active_transfer() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local transfer=$(ps aux | grep -E &quot;(bbcp|tsunami)&quot; | grep -v grep | wc -l)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ $transfer -gt 0 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;运行中: $transfer 个传输进程&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;空闲&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;=== 备份状态监控 ===&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;时间: $(date)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;1. 备份状态:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check_recent_backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;2. NAS空间:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check_nas_space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;3. 传输进程:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check_active_transfer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;4. 最近日志:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ls -t ${LOG_DIR}/bbcp_*.log 2&gt;/dev/null | head -3 | while read f; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;  $(basename $f): $(tail -1 $f 2&gt;/dev/null)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main &quot;$@&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="62-prometheus-监控指标">6.2 Prometheus 监控指标<a href="#62-prometheus-监控指标" class="hash-link" aria-label="Direct link to 6.2 Prometheus 监控指标" title="Direct link to 6.2 Prometheus 监控指标" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -/scripts/backup-metrics.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 导出Prometheus指标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_DIR=&quot;${HOME}/.local/share/backup/logs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 最后备份时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LAST_BACKUP=$(ls -t ${LOG_DIR}/bbcp_*.log 2&gt;/dev/null | head -1 | xargs stat -c %Y 2&gt;/dev/null || echo 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NOW=$(date +%s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AGE=$((NOW - LAST_BACKUP))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP backup_last_success_timestamp_seconds Unixtime of last successful backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE backup_last_success_timestamp_seconds gauge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backup_last_success_timestamp_seconds $LAST_BACKUP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP backup_age_seconds Seconds since last backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE backup_age_seconds gauge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backup_age_seconds $AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP backup_last_transfer_speed_bytes_per_second</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE backup_last_transfer_speed_bytes_per_second gauge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backup_last_transfer_speed_bytes_per_second $(tail -50 ${LOG_DIR}/bbcp_*.log 2&gt;/dev/null | grep -oP &#x27;\d+\s+bytes/s&#x27; | head -1 | awk &#x27;{print $1}&#x27; || echo 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP backup_errors_total Total number of backup errors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE backup_errors_total counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backup_errors_total $(grep -c &quot;错误&quot; ${LOG_DIR}/bbcp_*.log 2&gt;/dev/null || echo 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="七故障排查">七、故障排查<a href="#七故障排查" class="hash-link" aria-label="Direct link to 七、故障排查" title="Direct link to 七、故障排查" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="71-常见问题">7.1 常见问题<a href="#71-常见问题" class="hash-link" aria-label="Direct link to 7.1 常见问题" title="Direct link to 7.1 常见问题" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 1. 连接失败</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh -vvv -c none backup@192.168.1.100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2. 速度不达标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 检查网络</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iperf3 -c 192.168.1.100 -P 4 -t 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 检查CPU</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">top -bn1 | grep -E &quot;(bbcp|ssh|encryption)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 检查磁盘IO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iotop -b -n 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3. TCP窗口过小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 检查系统配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sysctl net.ipv4.tcp_rmem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sysctl net.core.rmem_max</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 4. MTU问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping -M do -s 8972 192.168.1.100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 5. 文件权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ls -la /data/training/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="72-性能调优检查清单">7.2 性能调优检查清单<a href="#72-性能调优检查清单" class="hash-link" aria-label="Direct link to 7.2 性能调优检查清单" title="Direct link to 7.2 性能调优检查清单" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -/scripts/check-tuning.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;=== 性能调优检查 ===&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 1. 网卡MTU</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo -n &quot;MTU: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip link show eth0 | grep -oP &#x27;mtu \K\d+&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2. TCP缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo -n &quot;TCP rmem_max: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sysctl net.core.rmem_max 2&gt;/dev/null | awk &#x27;{print $3}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3. 打开文件数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo -n &quot;ulimit -n: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ulimit -n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 4. bbcp版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bbcp --version 2&gt;&amp;1 | head -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 5. SSH加密</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo -n &quot;SSH Ciphers: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh -c none -o BatchMode=yes localhost &quot;echo OK&quot; 2&gt;&amp;1 | grep -q &quot;OK&quot; &amp;&amp; echo &quot;none可用&quot; || echo &quot;none不可用&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 6. 网络带宽</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;网络带宽测试:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iperf3 -c 192.168.1.100 -t 5 -J | jq &#x27;.end.sum_sent.bits_per_second / 1e9&#x27;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="八部署检查清单">八、部署检查清单<a href="#八部署检查清单" class="hash-link" aria-label="Direct link to 八、部署检查清单" title="Direct link to 八、部署检查清单" translate="no">​</a></h3>
<ul class="contains-task-list containsTaskList_mC6p">
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->网络带宽测试通过 (&gt;= 9Gbps)</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->丢包率 &lt; 0.01%</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->MTU 设置为 9000</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->系统参数已优化 (<code>net.core.rmem_max &gt;= 536870912</code>)</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->bbcp 安装完成并验证</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Tsunami UDP 安装完成（可选）</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->SSH 免密登录配置完成</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->NAS 目录权限配置正确</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->备份脚本测试通过</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Systemd Timer 启用</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->监控脚本配置完成</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->首次完整备份成功</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->恢复测试通过</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="九回滚方案">九、回滚方案<a href="#九回滚方案" class="hash-link" aria-label="Direct link to 九、回滚方案" title="Direct link to 九、回滚方案" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -/scripts/rollback-bbcp.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;=== bbcp 回滚到 rclone ===&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 切换到rclone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sed -i &#x27;s/bbcp/rclone/g&#x27; -/scripts/backup.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sed -i &#x27;s/--transfers.*/--transfers 8 \\/g&#x27; -/scripts/backup.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 重启服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl --user stop backup-bbcp.timer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl --user disable backup-bbcp.timer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl --user enable backup-rclone.timer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl --user start backup-rclone.timer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;已切换到rclone备份&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;查看状态: systemctl --user list-timers&quot;</span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/training-data-backup.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/full-it-infra-design-docs/docs/datacenter-infra"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">机房基础设施设计</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#场景分析" class="table-of-contents__link toc-highlight">场景分析</a><ul><li><a href="#两种工作模式" class="table-of-contents__link toc-highlight">两种工作模式</a></li><li><a href="#wfh-场景的特殊性" class="table-of-contents__link toc-highlight">WFH 场景的特殊性</a></li></ul></li><li><a href="#传输模式对比" class="table-of-contents__link toc-highlight">传输模式对比</a><ul><li><a href="#拉取模式协议需要客户端可访问" class="table-of-contents__link toc-highlight">拉取模式协议（需要客户端可访问）</a></li><li><a href="#推送模式协议适合wfh" class="table-of-contents__link toc-highlight">推送模式协议（适合WFH）</a></li><li><a href="#完整对比表按速度排序" class="table-of-contents__link toc-highlight">完整对比表（按速度排序）</a></li><li><a href="#完整对比表按速度排序-1" class="table-of-contents__link toc-highlight">完整对比表（按速度排序）</a></li></ul></li><li><a href="#推荐方案" class="table-of-contents__link toc-highlight">推荐方案</a><ul><li><a href="#场景1办公室有线网络推荐-namida" class="table-of-contents__link toc-highlight">场景1：办公室有线网络（推荐 Namida）</a></li><li><a href="#场景2wfh远程办公推荐-bbcp" class="table-of-contents__link toc-highlight">场景2：WFH远程办公（推荐 bbcp）</a></li><li><a href="#场景3混合环境统一用-bbcp" class="table-of-contents__link toc-highlight">场景3：混合环境（统一用 bbcp）</a></li></ul></li><li><a href="#wfh场景-namida-服务发现问题" class="table-of-contents__link toc-highlight">WFH场景 Namida 服务发现问题</a><ul><li><a href="#问题描述" class="table-of-contents__link toc-highlight">问题描述</a></li><li><a href="#解决方案对比" class="table-of-contents__link toc-highlight">解决方案对比</a></li><li><a href="#方案a客户端注册--namida拉取" class="table-of-contents__link toc-highlight">方案A：客户端注册 + Namida拉取</a></li><li><a href="#方案budp心跳注册简化版" class="table-of-contents__link toc-highlight">方案B：UDP心跳注册（简化版）</a></li><li><a href="#方案对比与推荐" class="table-of-contents__link toc-highlight">方案对比与推荐</a></li><li><a href="#推荐统一使用-bbcp-推送模式" class="table-of-contents__link toc-highlight">推荐：统一使用 bbcp 推送模式</a></li></ul></li><li><a href="#速度优先推荐方案namida仅限办公室" class="table-of-contents__link toc-highlight">速度优先推荐方案：Namida（仅限办公室）</a><ul><li><a href="#namida-优势" class="table-of-contents__link toc-highlight">Namida 优势</a></li><li><a href="#namida-安装" class="table-of-contents__link toc-highlight">Namida 安装</a></li><li><a href="#tsunami-udp-使用" class="table-of-contents__link toc-highlight">Tsunami UDP 使用</a></li><li><a href="#tsunami-udp-完整脚本" class="table-of-contents__link toc-highlight">Tsunami UDP 完整脚本</a></li></ul></li><li><a href="#wfh推荐方案bbcp推送模式" class="table-of-contents__link toc-highlight">WFH推荐方案：bbcp（推送模式）</a><ul><li><a href="#为什么-bbcp-适合-wfh" class="table-of-contents__link toc-highlight">为什么 bbcp 适合 WFH</a></li><li><a href="#bbcp-vs-namida-对比wfh场景" class="table-of-contents__link toc-highlight">bbcp vs Namida 对比（WFH场景）</a></li><li><a href="#bbcp-安装" class="table-of-contents__link toc-highlight">bbcp 安装</a></li><li><a href="#bbcp-wfh推送脚本" class="table-of-contents__link toc-highlight">bbcp WFH推送脚本</a></li></ul></li><li><a href="#备选方案mbuffer--tar--ssh" class="table-of-contents__link toc-highlight">备选方案：mbuffer + tar + ssh</a><ul><li><a href="#mbuffer-vs-bbcp-对比" class="table-of-contents__link toc-highlight">mbuffer vs bbcp 对比</a></li><li><a href="#性能验证" class="table-of-contents__link toc-highlight">性能验证</a></li><li><a href="#mbuffer-安装" class="table-of-contents__link toc-highlight">mbuffer 安装</a></li><li><a href="#mbuffer-基础用法" class="table-of-contents__link toc-highlight">mbuffer 基础用法</a></li><li><a href="#mbuffer--bbcp-完整脚本" class="table-of-contents__link toc-highlight">mbuffer + bbcp 完整脚本</a></li><li><a href="#mbuffer-性能调优" class="table-of-contents__link toc-highlight">mbuffer 性能调优</a></li><li><a href="#mbuffer-systemd-timer" class="table-of-contents__link toc-highlight">mbuffer Systemd Timer</a></li><li><a href="#mbuffer-选择建议" class="table-of-contents__link toc-highlight">mbuffer 选择建议</a></li><li><a href="#bbcp-systemd-timerwfh场景" class="table-of-contents__link toc-highlight">bbcp Systemd Timer（WFH场景）</a></li><li><a href="#wfh场景完整方案对比" class="table-of-contents__link toc-highlight">WFH场景完整方案对比</a></li><li><a href="#统一备份脚本自动适配" class="table-of-contents__link toc-highlight">统一备份脚本（自动适配）</a></li><li><a href="#方案选择决策树" class="table-of-contents__link toc-highlight">方案选择决策树</a></li><li><a href="#最终推荐配置" class="table-of-contents__link toc-highlight">最终推荐配置</a></li><li><a href="#bbcp-多文件并行传输" class="table-of-contents__link toc-highlight">bbcp 多文件并行传输</a></li><li><a href="#systemd-timer配置bbcp极速版" class="table-of-contents__link toc-highlight">Systemd Timer配置（bbcp极速版）</a></li><li><a href="#gridftp-极速配置可选" class="table-of-contents__link toc-highlight">GridFTP 极速配置（可选）</a></li><li><a href="#bbcp-优势速度优先" class="table-of-contents__link toc-highlight">bbcp 优势（速度优先）</a></li><li><a href="#bbcp-安装-1" class="table-of-contents__link toc-highlight">bbcp 安装</a></li><li><a href="#bbcp-使用" class="table-of-contents__link toc-highlight">bbcp 使用</a></li><li><a href="#bbcp-完整脚本" class="table-of-contents__link toc-highlight">bbcp 完整脚本</a></li></ul></li><li><a href="#速度优化参数对比" class="table-of-contents__link toc-highlight">速度优化参数对比</a><ul><li><a href="#不同网络环境的最佳选择速度优先" class="table-of-contents__link toc-highlight">不同网络环境的最佳选择（速度优先）</a></li><li><a href="#参数调优建议速度优先" class="table-of-contents__link toc-highlight">参数调优建议（速度优先）</a></li></ul></li><li><a href="#边传边删策略" class="table-of-contents__link toc-highlight">边传边删策略</a><ul><li><a href="#方案对比" class="table-of-contents__link toc-highlight">方案对比</a></li><li><a href="#推荐策略" class="table-of-contents__link toc-highlight">推荐策略</a></li></ul></li><li><a href="#方案选择建议速度优先" class="table-of-contents__link toc-highlight">方案选择建议（速度优先）</a><ul><li><a href="#最终推荐配置速度优先" class="table-of-contents__link toc-highlight">最终推荐配置（速度优先）</a></li></ul></li><li><a href="#udp极速方案tsunami-udp-protocol" class="table-of-contents__link toc-highlight">UDP极速方案：Tsunami UDP Protocol</a><ul><li><a href="#为什么udp在好网络下更快" class="table-of-contents__link toc-highlight">为什么UDP在好网络下更快？</a></li><li><a href="#参考资料与研究佐证" class="table-of-contents__link toc-highlight">参考资料与研究佐证</a></li><li><a href="#tsunami-udp-protocol" class="table-of-contents__link toc-highlight">Tsunami UDP Protocol</a></li><li><a href="#udt-udp-based-data-transfer" class="table-of-contents__link toc-highlight">UDT (UDP-based Data Transfer)</a></li><li><a href="#udp方案对比" class="table-of-contents__link toc-highlight">UDP方案对比</a></li><li><a href="#现代化实现namida推荐" class="table-of-contents__link toc-highlight">现代化实现：Namida（推荐）</a></li><li><a href="#tsunami-完整脚本" class="table-of-contents__link toc-highlight">Tsunami 完整脚本</a></li><li><a href="#udp方案使用建议" class="table-of-contents__link toc-highlight">UDP方案使用建议</a></li><li><a href="#综合推荐速度优先" class="table-of-contents__link toc-highlight">综合推荐（速度优先）</a></li></ul></li><li><a href="#详细部署落地方案" class="table-of-contents__link toc-highlight">详细部署落地方案</a><ul><li><a href="#一环境准备" class="table-of-contents__link toc-highlight">一、环境准备</a></li><li><a href="#二安装部署" class="table-of-contents__link toc-highlight">二、安装部署</a></li><li><a href="#三配置部署" class="table-of-contents__link toc-highlight">三、配置部署</a></li><li><a href="#四systemd-服务配置" class="table-of-contents__link toc-highlight">四、Systemd 服务配置</a></li><li><a href="#五备份脚本" class="table-of-contents__link toc-highlight">五、备份脚本</a></li><li><a href="#六监控与告警" class="table-of-contents__link toc-highlight">六、监控与告警</a></li><li><a href="#七故障排查" class="table-of-contents__link toc-highlight">七、故障排查</a></li><li><a href="#八部署检查清单" class="table-of-contents__link toc-highlight">八、部署检查清单</a></li><li><a href="#九回滚方案" class="table-of-contents__link toc-highlight">九、回滚方案</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/full-it-infra-design-docs/docs/intro">项目简介</a></li><li class="footer__item"><a class="footer__link-item" href="/full-it-infra-design-docs/docs/it-infra-design">IT 基础架构设计</a></li><li class="footer__item"><a class="footer__link-item" href="/full-it-infra-design-docs/docs/switch-selection">交换机选型</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">资源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/stars-labs/full-it-infra-design-docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Stars Labs. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>