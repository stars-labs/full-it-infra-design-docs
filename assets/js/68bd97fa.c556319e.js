"use strict";(globalThis.webpackChunkfull_it_infra_design_docs=globalThis.webpackChunkfull_it_infra_design_docs||[]).push([[3756],{5383(e,n,r){r.r(n),r.d(n,{assets:()=>i,contentTitle:()=>t,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"hardware/llm-inference-cluster/deployment-guide","title":"\u5feb\u901f\u90e8\u7f72\u53c2\u8003","description":"\u672c\u6587\u6863\u63d0\u4f9b\u5927\u6a21\u578b\u63a8\u7406\u96c6\u7fa4\u7684\u5feb\u901f\u90e8\u7f72\u53c2\u8003,\u5305\u62ec\u5b8c\u6574\u7684Docker Compose\u914d\u7f6e\u548c\u5e38\u7528\u8fd0\u7ef4\u547d\u4ee4\u3002","source":"@site/docs/02-hardware/llm-inference-cluster/deployment-guide.md","sourceDirName":"02-hardware/llm-inference-cluster","slug":"/hardware/llm-inference-cluster/deployment-guide","permalink":"/full-it-infra-design-docs/docs/hardware/llm-inference-cluster/deployment-guide","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/02-hardware/llm-inference-cluster/deployment-guide.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8},"sidebar":"tutorialSidebar","previous":{"title":"\u98ce\u9669\u4e0e\u6ce8\u610f\u4e8b\u9879","permalink":"/full-it-infra-design-docs/docs/hardware/llm-inference-cluster/risk-analysis"},"next":{"title":"NAS \u786c\u4ef6\u9009\u578b\u6982\u89c8","permalink":"/full-it-infra-design-docs/docs/hardware/nas-selection/"}}');var a=r(4848),d=r(8453);const l={sidebar_position:8},t="\u5feb\u901f\u90e8\u7f72\u53c2\u8003",i={},c=[{value:"Docker Compose \u5b8c\u6574\u914d\u7f6e",id:"docker-compose-\u5b8c\u6574\u914d\u7f6e",level:2},{value:"\u5feb\u901f\u542f\u52a8",id:"\u5feb\u901f\u542f\u52a8",level:3},{value:"\u5e38\u7528\u8fd0\u7ef4\u547d\u4ee4",id:"\u5e38\u7528\u8fd0\u7ef4\u547d\u4ee4",level:2},{value:"GPU\u76d1\u63a7",id:"gpu\u76d1\u63a7",level:3},{value:"vLLM\u670d\u52a1",id:"vllm\u670d\u52a1",level:3},{value:"Qdrant\u5411\u91cf\u5e93",id:"qdrant\u5411\u91cf\u5e93",level:3},{value:"Docker\u7ba1\u7406",id:"docker\u7ba1\u7406",level:3},{value:"\u7cfb\u7edf\u76d1\u63a7",id:"\u7cfb\u7edf\u76d1\u63a7",level:3},{value:"\u6027\u80fd\u6d4b\u8bd5",id:"\u6027\u80fd\u6d4b\u8bd5",level:3},{value:"\u5907\u4efd\u4e0e\u6062\u590d",id:"\u5907\u4efd\u4e0e\u6062\u590d",level:3},{value:"\u670d\u52a1\u7aef\u53e3\u8bf4\u660e",id:"\u670d\u52a1\u7aef\u53e3\u8bf4\u660e",level:2},{value:"\u6545\u969c\u6392\u67e5",id:"\u6545\u969c\u6392\u67e5",level:2},{value:"GPU\u76f8\u5173",id:"gpu\u76f8\u5173",level:3},{value:"\u5bb9\u5668\u76f8\u5173\u95ee\u9898",id:"\u5bb9\u5668\u76f8\u5173\u95ee\u9898",level:3},{value:"\u7f51\u7edc\u95ee\u9898",id:"\u7f51\u7edc\u95ee\u9898",level:3},{value:"\u53c2\u8003\u8d44\u6599",id:"\u53c2\u8003\u8d44\u6599",level:2},{value:"\u76f8\u5173\u6587\u6863",id:"\u76f8\u5173\u6587\u6863",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"\u5feb\u901f\u90e8\u7f72\u53c2\u8003",children:"\u5feb\u901f\u90e8\u7f72\u53c2\u8003"})}),"\n",(0,a.jsx)(n.p,{children:"\u672c\u6587\u6863\u63d0\u4f9b\u5927\u6a21\u578b\u63a8\u7406\u96c6\u7fa4\u7684\u5feb\u901f\u90e8\u7f72\u53c2\u8003,\u5305\u62ec\u5b8c\u6574\u7684Docker Compose\u914d\u7f6e\u548c\u5e38\u7528\u8fd0\u7ef4\u547d\u4ee4\u3002"}),"\n",(0,a.jsx)(n.h2,{id:"docker-compose-\u5b8c\u6574\u914d\u7f6e",children:"Docker Compose \u5b8c\u6574\u914d\u7f6e"}),"\n",(0,a.jsx)(n.p,{children:"\u4ee5\u4e0b\u662f\u4e00\u4e2a\u5b8c\u6574\u7684Docker Compose\u914d\u7f6e,\u5305\u542bvLLM\u63a8\u7406\u670d\u52a1\u3001Qdrant\u5411\u91cf\u6570\u636e\u5e93\u3001Nginx\u53cd\u5411\u4ee3\u7406\u3001Prometheus\u76d1\u63a7\u548cGrafana\u53ef\u89c6\u5316\u3002"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"version: '3.8'\n\nservices:\n  # vLLM\u63a8\u7406\u670d\u52a1\n  vllm:\n    image: vllm/vllm-openai:latest\n    container_name: vllm-inference\n    ports: [\"8000:8000\"]\n    volumes:\n      - ./models:/models\n      - ./data:/data\n    command: >\n      --model deepseek-ai/deepseek-coder-6.7b-instruct\n      --tensor-parallel-size 4\n      --gpu-memory-utilization 0.9\n      --max-model-len 8192\n    deploy:\n      resources:\n        reservations:\n          devices:\n            - driver: nvidia\n              device_ids: ['0', '1', '2', '3']\n              capabilities: [gpu]\n\n  # Qdrant\u5411\u91cf\u6570\u636e\u5e93\n  qdrant:\n    image: qdrant/qdrant:latest\n    container_name: qdrant\n    ports: [\"6333:6333\", \"6334:6334\"]\n    volumes:\n      - ./qdrant/storage:/qdrant/storage\n    command: ./qdrant --grpc-port 6334 --port 6333\n\n  # Nginx\u53cd\u5411\u4ee3\u7406\n  nginx:\n    image: nginx:1.24-alpine\n    container_name: nginx-proxy\n    ports: [\"80:80\", \"443:443\"]\n    volumes:\n      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro\n      - ./nginx/ssl:/etc/nginx/ssl:ro\n    depends_on: [vllm, qdrant]\n\n  # Prometheus\u76d1\u63a7\n  prometheus:\n    image: prom/prometheus:latest\n    container_name: prometheus\n    ports: [\"9090:9090\"]\n    volumes:\n      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro\n      - ./prometheus/data:/prometheus\n    command: ['--config.file=/etc/prometheus/prometheus.yml', '--storage.tsdb.path=/prometheus']\n\n  # Grafana\u53ef\u89c6\u5316\n  grafana:\n    image: grafana/grafana:latest\n    container_name: grafana\n    ports: [\"3000:3000\"]\n    volumes:\n      - ./grafana/data:/var/lib/grafana\n      - ./grafana/provisioning:/etc/grafana/provisioning\n    environment:\n      - GF_SECURITY_ADMIN_PASSWORD=admin\n    depends_on: [prometheus]\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u5feb\u901f\u542f\u52a8",children:"\u5feb\u901f\u542f\u52a8"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# 1. \u514b\u9686\u6216\u521b\u5efa\u9879\u76ee\u76ee\u5f55\nmkdir llm-cluster && cd llm-cluster\n\n# 2. \u521b\u5efa\u5fc5\u8981\u7684\u76ee\u5f55\u7ed3\u6784\nmkdir -p models data qdrant/storage nginx/ssl prometheus/data grafana/data grafana/provisioning\n\n# 3. \u5c06\u4e0a\u9762\u7684\u914d\u7f6e\u4fdd\u5b58\u4e3a docker-compose.yml\n\n# 4. \u542f\u52a8\u6240\u6709\u670d\u52a1\ndocker-compose up -d\n\n# 5. \u67e5\u770b\u670d\u52a1\u72b6\u6001\ndocker-compose ps\n\n# 6. \u67e5\u770b\u65e5\u5fd7\ndocker-compose logs -f\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u5e38\u7528\u8fd0\u7ef4\u547d\u4ee4",children:"\u5e38\u7528\u8fd0\u7ef4\u547d\u4ee4"}),"\n",(0,a.jsx)(n.h3,{id:"gpu\u76d1\u63a7",children:"GPU\u76d1\u63a7"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# GPU\u72b6\u6001\u76d1\u63a7\uff08\u6bcf\u79d2\u5237\u65b0\uff09\nnvidia-smi -l 1\n\n# \u67e5\u770bGPU\u8be6\u7ec6\u4fe1\u606f\nnvidia-smi -q\n\n# \u67e5\u770bCUDA\u7248\u672c\nnvcc --version\n\n# \u68c0\u67e5GPU\u662f\u5426\u53ef\u7528\npython -c "import torch; print(torch.cuda.is_available())"\n'})}),"\n",(0,a.jsx)(n.h3,{id:"vllm\u670d\u52a1",children:"vLLM\u670d\u52a1"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# \u6d4b\u8bd5vLLM\u670d\u52a1\ncurl http://localhost:8000/v1/models\n\n# \u53d1\u9001\u63a8\u7406\u8bf7\u6c42\ncurl http://localhost:8000/v1/chat/completions \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "model": "deepseek-ai/deepseek-coder-6.7b-instruct",\n    "messages": [{"role": "user", "content": "Hello!"}]\n  }\'\n\n# \u67e5\u770bvLLM\u65e5\u5fd7\ndocker logs -f vllm-inference --tail 100\n\n# \u91cd\u542fvLLM\u670d\u52a1\ndocker-compose restart vllm\n'})}),"\n",(0,a.jsx)(n.h3,{id:"qdrant\u5411\u91cf\u5e93",children:"Qdrant\u5411\u91cf\u5e93"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# Qdrant\u5065\u5eb7\u68c0\u67e5\ncurl http://localhost:6333/health\n\n# \u521b\u5efa\u96c6\u5408\ncurl -X PUT http://localhost:6333/collections/my_collection \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "vectors": {\n      "size": 768,\n      "distance": "Cosine"\n    }\n  }\'\n\n# Qdrant\u5907\u4efd\ndocker exec qdrant qdrant-backup create\n\n# \u67e5\u770bQdrant\u65e5\u5fd7\ndocker logs -f qdrant --tail 100\n'})}),"\n",(0,a.jsx)(n.h3,{id:"docker\u7ba1\u7406",children:"Docker\u7ba1\u7406"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u67e5\u770b\u6240\u6709\u5bb9\u5668\ndocker ps -a\n\n# \u67e5\u770b\u5bb9\u5668\u8d44\u6e90\u4f7f\u7528\ndocker stats\n\n# \u91cd\u542f\u6240\u6709\u670d\u52a1\ndocker-compose restart\n\n# \u505c\u6b62\u6240\u6709\u670d\u52a1\ndocker-compose down\n\n# \u505c\u6b62\u5e76\u5220\u9664\u6570\u636e\ndocker-compose down -v\n\n# \u67e5\u770b\u670d\u52a1\u65e5\u5fd7\ndocker-compose logs -f [service_name]\n\n# \u8fdb\u5165\u5bb9\u5668\ndocker exec -it [container_name] /bin/bash\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u7cfb\u7edf\u76d1\u63a7",children:"\u7cfb\u7edf\u76d1\u63a7"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u7cfb\u7edf\u8d1f\u8f7d\u76d1\u63a7\nhtop\n\n# \u67e5\u770b\u5185\u5b58\u4f7f\u7528\nfree -h\n\n# \u67e5\u770b\u78c1\u76d8\u4f7f\u7528\ndf -h\n\n# \u67e5\u770b\u78c1\u76d8IO\niostat -x 1\n\n# \u67e5\u770b\u7f51\u7edc\u8fde\u63a5\nnetstat -tuln\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u6027\u80fd\u6d4b\u8bd5",children:"\u6027\u80fd\u6d4b\u8bd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u7f51\u7edc\u5e26\u5bbd\u6d4b\u8bd5\niperf3 -s  # \u670d\u52a1\u7aef\niperf3 -c <\u670d\u52a1\u5668IP>  # \u5ba2\u6237\u7aef\n\n# \u78c1\u76d8IO\u6d4b\u8bd5\nfio --name=randread --ioengine=libaio --iodepth=1 \\\n    --rw=randread --bs=4k --direct=1 --size=1G \\\n    --numjobs=1 --runtime=60 --time_based \\\n    --group_reporting --filename=/data/test\n\n# \u538b\u529b\u6d4b\u8bd5\nstress --cpu 4 --io 2 --vm 1 --vm-bytes 128M --timeout 300s\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u5907\u4efd\u4e0e\u6062\u590d",children:"\u5907\u4efd\u4e0e\u6062\u590d"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Qdrant\u6570\u636e\u5e93\u5907\u4efd\ndocker exec qdrant qdrant-backup create\n\n# \u6062\u590dQdrant\u5907\u4efd\ndocker exec qdrant qdrant-backup restore\n\n# \u5907\u4efdDocker volumes\ndocker run --rm -v qdrant_storage:/data -v $(pwd):/backup alpine tar czf /backup/qdrant-backup.tar.gz /data\n\n# \u6062\u590dDocker volumes\ndocker run --rm -v qdrant_storage:/data -v $(pwd):/backup alpine tar xzf /backup/qdrant-backup.tar.gz -C /\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u670d\u52a1\u7aef\u53e3\u8bf4\u660e",children:"\u670d\u52a1\u7aef\u53e3\u8bf4\u660e"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"\u670d\u52a1"}),(0,a.jsx)(n.th,{children:"\u7aef\u53e3"}),(0,a.jsx)(n.th,{children:"\u8bf4\u660e"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"vLLM"}),(0,a.jsx)(n.td,{children:"8000"}),(0,a.jsx)(n.td,{children:"\u63a8\u7406API\u670d\u52a1"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Qdrant HTTP"}),(0,a.jsx)(n.td,{children:"6333"}),(0,a.jsx)(n.td,{children:"\u5411\u91cf\u5e93HTTP\u63a5\u53e3"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Qdrant gRPC"}),(0,a.jsx)(n.td,{children:"6334"}),(0,a.jsx)(n.td,{children:"\u5411\u91cf\u5e93gRPC\u63a5\u53e3"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Nginx HTTP"}),(0,a.jsx)(n.td,{children:"80"}),(0,a.jsx)(n.td,{children:"Web\u670d\u52a1"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Nginx HTTPS"}),(0,a.jsx)(n.td,{children:"443"}),(0,a.jsx)(n.td,{children:"HTTPS\u670d\u52a1"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Prometheus"}),(0,a.jsx)(n.td,{children:"9090"}),(0,a.jsx)(n.td,{children:"\u76d1\u63a7\u6570\u636e"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Grafana"}),(0,a.jsx)(n.td,{children:"3000"}),(0,a.jsx)(n.td,{children:"\u53ef\u89c6\u5316\u9762\u677f"})]})]})]}),"\n",(0,a.jsx)(n.h2,{id:"\u6545\u969c\u6392\u67e5",children:"\u6545\u969c\u6392\u67e5"}),"\n",(0,a.jsx)(n.h3,{id:"gpu\u76f8\u5173",children:"GPU\u76f8\u5173"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# GPU\u6e29\u5ea6\u8fc7\u9ad8\nnvidia-smi -q -d TEMPERATURE\n\n# GPU\u663e\u5b58\u4f7f\u7528\nnvidia-smi --query-gpu=memory.used,memory.total --format=csv\n\n# \u6e05\u7406GPU\u7f13\u5b58\npython -c "import torch; torch.cuda.empty_cache()"\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u5bb9\u5668\u76f8\u5173\u95ee\u9898",children:"\u5bb9\u5668\u76f8\u5173\u95ee\u9898"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u67e5\u770b\u5bb9\u5668\u5360\u7528\u8d44\u6e90\ndocker stats --no-stream\n\n# \u67e5\u770b\u5bb9\u5668\u8be6\u7ec6\u65e5\u5fd7\ndocker logs --tail 500 [container_name]\n\n# \u5bb9\u5668\u65e0\u6cd5\u542f\u52a8\ndocker inspect [container_name]\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u7f51\u7edc\u95ee\u9898",children:"\u7f51\u7edc\u95ee\u9898"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u68c0\u67e5\u7aef\u53e3\u662f\u5426\u76d1\u542c\nnetstat -tuln | grep -E '8000|6333|9090'\n\n# \u6d4b\u8bd5\u670d\u52a1\u8fde\u901a\u6027\ncurl -v http://localhost:8000/v1/models\n\n# \u68c0\u67e5\u9632\u706b\u5899\u89c4\u5219\nsudo iptables -L -n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u53c2\u8003\u8d44\u6599",children:"\u53c2\u8003\u8d44\u6599"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://docs.vllm.ai/",children:"vLLM\u5b98\u65b9\u6587\u6863"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://qdrant.tech/documentation/",children:"Qdrant\u5b98\u65b9\u6587\u6863"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://docs.docker.com/compose/",children:"Docker Compose\u6587\u6863"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://prometheus.io/docs/",children:"Prometheus\u6587\u6863"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://www.inspur.com/",children:"\u6d6a\u6f6eAI\u670d\u52a1\u5668\u4ea7\u54c1\u624b\u518c"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://developer.nvidia.com/blog/",children:"NVIDIA GPU\u6280\u672f\u535a\u5ba2"})}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"\u76f8\u5173\u6587\u6863",children:"\u76f8\u5173\u6587\u6863"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"./software-stack",children:"\u8f6f\u4ef6\u6808\u63a8\u8350"})," - \u63a8\u7406\u6846\u67b6\u548c\u5411\u91cf\u5e93\u9009\u578b"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"./deployment-environment",children:"\u529e\u516c\u5ba4\u90e8\u7f72\u73af\u5883"})," - \u7f51\u7edc\u67b6\u6784\u8bbe\u8ba1"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"./procurement",children:"\u91c7\u8d2d\u6e05\u5355\u4e0e\u9a8c\u6536"})," - \u9a8c\u6536\u6d4b\u8bd5\u6e05\u5355"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(o,{...e})}):o(e)}},8453(e,n,r){r.d(n,{R:()=>l,x:()=>t});var s=r(6540);const a={},d=s.createContext(a);function l(e){const n=s.useContext(d);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),s.createElement(d.Provider,{value:n},e.children)}}}]);