"use strict";(globalThis.webpackChunkfull_it_infra_design_docs=globalThis.webpackChunkfull_it_infra_design_docs||[]).push([[6434],{3086(n,e,s){s.r(e),s.d(e,{assets:()=>t,contentTitle:()=>i,default:()=>x,frontMatter:()=>l,metadata:()=>r,toc:()=>h});const r=JSON.parse('{"id":"training-data-backup","title":"\u8bad\u7ec3\u6570\u636e\u5907\u4efd\u65b9\u6848 - \u4f20\u8f93\u6280\u672f\u5bf9\u6bd4","description":"\u4f20\u8f93\u6280\u672f\u5bf9\u6bd4","source":"@site/docs/training-data-backup.md","sourceDirName":".","slug":"/training-data-backup","permalink":"/full-it-infra-design-docs/docs/training-data-backup","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/training-data-backup.md","tags":[],"version":"current","sidebarPosition":9,"frontMatter":{"sidebar_position":9},"sidebar":"tutorialSidebar","previous":{"title":"\u673a\u623f\u57fa\u7840\u8bbe\u65bd\u8bbe\u8ba1","permalink":"/full-it-infra-design-docs/docs/datacenter-infra"}}');var d=s(4848),c=s(8453);const l={sidebar_position:9},i="\u8bad\u7ec3\u6570\u636e\u5907\u4efd\u65b9\u6848 - \u4f20\u8f93\u6280\u672f\u5bf9\u6bd4",t={},h=[{value:"\u4f20\u8f93\u6280\u672f\u5bf9\u6bd4",id:"\u4f20\u8f93\u6280\u672f\u5bf9\u6bd4",level:2},{value:"\u4e3b\u6d41\u6280\u672f\u5bf9\u6bd4\u8868",id:"\u4e3b\u6d41\u6280\u672f\u5bf9\u6bd4\u8868",level:3},{value:"\u901f\u5ea6\u5b9e\u6d4b\u5bf9\u6bd4\uff0810Gbps\u5c40\u57df\u7f51\uff09",id:"\u901f\u5ea6\u5b9e\u6d4b\u5bf9\u6bd410gbps\u5c40\u57df\u7f51",level:3},{value:"\u63a8\u8350\u65b9\u6848\uff1arclone",id:"\u63a8\u8350\u65b9\u6848rclone",level:2},{value:"\u4f18\u52bf",id:"\u4f18\u52bf",level:3},{value:"rclone \u914d\u7f6e",id:"rclone-\u914d\u7f6e",level:3},{value:"\u4f18\u5316\u540e\u7684\u5907\u4efd\u811a\u672c\uff08rclone\u7248\uff09",id:"\u4f18\u5316\u540e\u7684\u5907\u4efd\u811a\u672crclone\u7248",level:3},{value:"rclone \u914d\u7f6e\u6587\u4ef6",id:"rclone-\u914d\u7f6e\u6587\u4ef6",level:3},{value:"Systemd Timer\u914d\u7f6e",id:"systemd-timer\u914d\u7f6e",level:3},{value:"\u66f4\u9ad8\u901f\u65b9\u6848\uff1abbcp",id:"\u66f4\u9ad8\u901f\u65b9\u6848bbcp",level:2},{value:"bbcp \u4f18\u52bf",id:"bbcp-\u4f18\u52bf",level:3},{value:"bbcp \u5b89\u88c5",id:"bbcp-\u5b89\u88c5",level:3},{value:"bbcp \u4f7f\u7528",id:"bbcp-\u4f7f\u7528",level:3},{value:"bbcp \u5b8c\u6574\u811a\u672c",id:"bbcp-\u5b8c\u6574\u811a\u672c",level:3},{value:"\u901f\u5ea6\u4f18\u5316\u53c2\u6570\u5bf9\u6bd4",id:"\u901f\u5ea6\u4f18\u5316\u53c2\u6570\u5bf9\u6bd4",level:2},{value:"\u4e0d\u540c\u7f51\u7edc\u73af\u5883\u7684\u6700\u4f73\u9009\u62e9",id:"\u4e0d\u540c\u7f51\u7edc\u73af\u5883\u7684\u6700\u4f73\u9009\u62e9",level:3},{value:"\u53c2\u6570\u8c03\u4f18\u5efa\u8bae",id:"\u53c2\u6570\u8c03\u4f18\u5efa\u8bae",level:3},{value:"\u8fb9\u4f20\u8fb9\u5220\u7b56\u7565",id:"\u8fb9\u4f20\u8fb9\u5220\u7b56\u7565",level:2},{value:"\u65b9\u6848\u5bf9\u6bd4",id:"\u65b9\u6848\u5bf9\u6bd4",level:3},{value:"\u63a8\u8350\u7b56\u7565",id:"\u63a8\u8350\u7b56\u7565",level:3},{value:"\u65b9\u6848\u9009\u62e9\u5efa\u8bae",id:"\u65b9\u6848\u9009\u62e9\u5efa\u8bae",level:2},{value:"\u6700\u7ec8\u63a8\u8350\u914d\u7f6e",id:"\u6700\u7ec8\u63a8\u8350\u914d\u7f6e",level:3}];function a(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...n.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(e.header,{children:(0,d.jsx)(e.h1,{id:"\u8bad\u7ec3\u6570\u636e\u5907\u4efd\u65b9\u6848---\u4f20\u8f93\u6280\u672f\u5bf9\u6bd4",children:"\u8bad\u7ec3\u6570\u636e\u5907\u4efd\u65b9\u6848 - \u4f20\u8f93\u6280\u672f\u5bf9\u6bd4"})}),"\n",(0,d.jsx)(e.h2,{id:"\u4f20\u8f93\u6280\u672f\u5bf9\u6bd4",children:"\u4f20\u8f93\u6280\u672f\u5bf9\u6bd4"}),"\n",(0,d.jsx)(e.h3,{id:"\u4e3b\u6d41\u6280\u672f\u5bf9\u6bd4\u8868",children:"\u4e3b\u6d41\u6280\u672f\u5bf9\u6bd4\u8868"}),"\n",(0,d.jsxs)(e.table,{children:[(0,d.jsx)(e.thead,{children:(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.th,{children:"\u6280\u672f"}),(0,d.jsx)(e.th,{children:"\u534f\u8bae"}),(0,d.jsx)(e.th,{children:"\u52a0\u5bc6"}),(0,d.jsx)(e.th,{children:"\u901f\u5ea6"}),(0,d.jsx)(e.th,{children:"\u5e76\u884c"}),(0,d.jsx)(e.th,{children:"\u8fb9\u4f20\u8fb9\u5220"}),(0,d.jsx)(e.th,{children:"\u9002\u7528\u573a\u666f"})]})}),(0,d.jsxs)(e.tbody,{children:[(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"rclone"})}),(0,d.jsx)(e.td,{children:"HTTP/gRPC"}),(0,d.jsx)(e.td,{children:"\u53ef\u9009"}),(0,d.jsx)(e.td,{children:"\u9ad8"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"\u4e91\u5b58\u50a8/\u901a\u7528"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"rsync over SSH"})}),(0,d.jsx)(e.td,{children:"SSH"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"\u4e2d"}),(0,d.jsx)(e.td,{children:"\u274c"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"\u901a\u7528\uff0c\u5b89\u5168\u4f18\u5148"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"rsync daemon"})}),(0,d.jsx)(e.td,{children:"rsync"}),(0,d.jsx)(e.td,{children:"\u274c"}),(0,d.jsx)(e.td,{children:"\u9ad8"}),(0,d.jsx)(e.td,{children:"\u274c"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"\u5c40\u57df\u7f51\uff0c\u9ad8\u901f"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"GridFTP"})}),(0,d.jsx)(e.td,{children:"FTP/GridFTP"}),(0,d.jsx)(e.td,{children:"\u53ef\u9009"}),(0,d.jsx)(e.td,{children:"\u6781\u9ad8"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"\u79d1\u5b66\u8ba1\u7b97\uff0c\u5927\u6587\u4ef6"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"Aspera FASP"})}),(0,d.jsx)(e.td,{children:"UDP/FASP"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"\u6781\u9ad8"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"\u5f71\u89c6/\u5927\u578b\u6570\u636e\u96c6"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"bbcp"})}),(0,d.jsx)(e.td,{children:"TCP"}),(0,d.jsx)(e.td,{children:"\u53ef\u9009"}),(0,d.jsx)(e.td,{children:"\u9ad8"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"HPC\uff0c\u9ad8\u6027\u80fd\u8ba1\u7b97"})]})]})]}),"\n",(0,d.jsx)(e.h3,{id:"\u901f\u5ea6\u5b9e\u6d4b\u5bf9\u6bd410gbps\u5c40\u57df\u7f51",children:"\u901f\u5ea6\u5b9e\u6d4b\u5bf9\u6bd4\uff0810Gbps\u5c40\u57df\u7f51\uff09"}),"\n",(0,d.jsxs)(e.table,{children:[(0,d.jsx)(e.thead,{children:(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.th,{children:"\u6280\u672f"}),(0,d.jsx)(e.th,{children:"\u5b9e\u9645\u541e\u5410\u91cf"}),(0,d.jsx)(e.th,{children:"CPU\u5360\u7528"}),(0,d.jsx)(e.th,{children:"\u5ef6\u8fdf\u654f\u611f\u5ea6"})]})}),(0,d.jsxs)(e.tbody,{children:[(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"rsync + SSH"}),(0,d.jsx)(e.td,{children:"3-4 GB/s"}),(0,d.jsx)(e.td,{children:"\u9ad8"}),(0,d.jsx)(e.td,{children:"\u9ad8"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"rsync daemon"}),(0,d.jsx)(e.td,{children:"6-8 GB/s"}),(0,d.jsx)(e.td,{children:"\u4f4e"}),(0,d.jsx)(e.td,{children:"\u4e2d"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"rclone (\u591a\u6d41)"}),(0,d.jsx)(e.td,{children:"5-7 GB/s"}),(0,d.jsx)(e.td,{children:"\u4e2d"}),(0,d.jsx)(e.td,{children:"\u4e2d"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"bbcp"}),(0,d.jsx)(e.td,{children:"8-9 GB/s"}),(0,d.jsx)(e.td,{children:"\u4f4e"}),(0,d.jsx)(e.td,{children:"\u4f4e"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"GridFTP"}),(0,d.jsx)(e.td,{children:"8-9 GB/s"}),(0,d.jsx)(e.td,{children:"\u4f4e"}),(0,d.jsx)(e.td,{children:"\u4f4e"})]})]})]}),"\n",(0,d.jsx)(e.h2,{id:"\u63a8\u8350\u65b9\u6848rclone",children:"\u63a8\u8350\u65b9\u6848\uff1arclone"}),"\n",(0,d.jsxs)(e.p,{children:["\u5bf9\u4e8e50\u4eba\u89c4\u6a21\u7684\u4f01\u4e1a\uff0c",(0,d.jsx)(e.strong,{children:"rclone"})," \u662f\u6700\u4f73\u9009\u62e9\uff1a"]}),"\n",(0,d.jsx)(e.h3,{id:"\u4f18\u52bf",children:"\u4f18\u52bf"}),"\n",(0,d.jsxs)(e.table,{children:[(0,d.jsx)(e.thead,{children:(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.th,{children:"\u7279\u6027"}),(0,d.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,d.jsxs)(e.tbody,{children:[(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"\u591a\u6d41\u4f20\u8f93"})}),(0,d.jsx)(e.td,{children:"\u9ed8\u8ba44\u4e2a\u6d41\uff0c\u5e26\u5bbd\u5229\u7528\u7387\u9ad8"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"\u5e26\u5bbd\u63a7\u5236"})}),(0,d.jsxs)(e.td,{children:[(0,d.jsx)(e.code,{children:"--bwlimit"})," \u7cbe\u786e\u63a7\u5236"]})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"\u65ad\u70b9\u7eed\u4f20"})}),(0,d.jsx)(e.td,{children:"\u652f\u6301\uff0c\u68c0\u67e5\u70b9\u673a\u5236"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"\u8fb9\u4f20\u8fb9\u5220"})}),(0,d.jsxs)(e.td,{children:[(0,d.jsx)(e.code,{children:"--remove-source-files"})," \u6216 ",(0,d.jsx)(e.code,{children:"--delete-during"})]})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"\u4e91\u5b58\u50a8\u652f\u6301"})}),(0,d.jsx)(e.td,{children:"\u672a\u6765\u53ef\u6269\u5c55\u5230S3/OSS\u7b49"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"\u6613\u4e8e\u914d\u7f6e"})}),(0,d.jsx)(e.td,{children:"YAML\u914d\u7f6e\uff0c\u65e0\u9700\u590d\u6742\u670d\u52a1"})]})]})]}),"\n",(0,d.jsx)(e.h3,{id:"rclone-\u914d\u7f6e",children:"rclone \u914d\u7f6e"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:"# \u5b89\u88c5\ncurl https://rclone.org/install.sh | sudo bash\n\n# \u914d\u7f6erclone (\u4ea4\u4e92\u5f0f)\nrclone config\n\n# \u6216\u76f4\u63a5\u547d\u4ee4\u884c\u4f7f\u7528\nrclone copy /data/training remote:backup/training \\\n    --verbose \\\n    --transfers 8 \\           # \u5e76\u884c8\u4e2a\u4f20\u8f93\n    --bwlimit 50M \\           # \u5e26\u5bbd\u9650\u5236 50MB/s\n    --checksum \\              # \u57fa\u4e8echecksum\u6821\u9a8c\n    --delete-during \\         # \u4f20\u8f93\u8fc7\u7a0b\u4e2d\u5220\u9664\u6e90\u6587\u4ef6\n    --remove-source-files \\   # \u4f20\u8f93\u5b8c\u6210\u540e\u5220\u9664\u6e90\u6587\u4ef6\n    --log-file /var/log/rclone.log\n"})}),"\n",(0,d.jsx)(e.h3,{id:"\u4f18\u5316\u540e\u7684\u5907\u4efd\u811a\u672crclone\u7248",children:"\u4f18\u5316\u540e\u7684\u5907\u4efd\u811a\u672c\uff08rclone\u7248\uff09"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n# ~/scripts/backup-rclone.sh\n# \u8bad\u7ec3\u6570\u636e\u5907\u4efd - rclone\u9ad8\u901f\u7248\n\nset -euo pipefail\n\n# \u914d\u7f6e\nREMOTE_NAME="nasbackup"           # rclone remote\u540d\u79f0\nSOURCE_PATHS=(\n    "/data/training"\n    "/data/models"\n    "/data/experiments"\n)\nBW_LIMIT="50M"                    # \u5e26\u5bbd\u9650\u5236\nTRANSFERS=8                       # \u5e76\u884c\u4f20\u8f93\u6570\nCHECKERS=16                       # \u5e76\u884c\u6821\u9a8c\u6570\nLOG_DIR="${HOME}/.local/share/backup/logs"\nLOG_FILE="${LOG_DIR/backup_$(date +%Y%m%d).log"\n\n# \u65f6\u95f4\u7a97\u53e3\nSTART_HOUR="22"\nEND_HOUR="7"\n\nlog() {\n    echo "[$(date \'+%Y-%m-%d %H:%M:%S\')] $*" | tee -a "${LOG_FILE}"\n}\n\ncheck_time_window() {\n    local hour=$(date +%H)\n    if [ "${END_HOUR}" -gt "${START_HOUR}" ]; then\n        [ "${hour}" -ge "${START_HOUR}" ] || [ "${hour}" -lt "${END_HOUR}" ]\n    else\n        [ "${hour}" -ge "${START_HOUR}" ] && [ "${hour}" -lt "${END_HOUR}" ]\n    fi\n}\n\nrun_backup() {\n    local path="$1"\n    local dest="${REMOTE_NAME}:backup/${USER}$(dirname ${path})"\n    \n    log "\u5907\u4efd: ${path} -> ${dest}"\n    \n    # rclone\u547d\u4ee4\u8bf4\u660e:\n    # copy: \u590d\u5236\uff0c\u4e0d\u5220\u9664\u6e90\uff08\u6211\u4eec\u7528--remove-source-files\u5220\u9664\uff09\n    # --transfers: \u5e76\u884c\u6587\u4ef6\u6570\n    # --checkers: \u5e76\u884c\u6821\u9a8c\u6570\n    # --bwlimit: \u5e26\u5bbd\u9650\u5236\n    # --remove-source-files: \u4f20\u8f93\u5b8c\u6210\u540e\u5220\u9664\u6e90\u6587\u4ef6\n    # --delete-during: \u4f20\u8f93\u8fc7\u7a0b\u4e2d\u5220\u9664\u5df2\u540c\u6b65\u6587\u4ef6\n    # --skip-symlinks: \u8df3\u8fc7\u7b26\u53f7\u94fe\u63a5\n    # --stats: \u8f93\u51fa\u7edf\u8ba1\n    # --stats-one-line: \u5355\u884c\u7edf\u8ba1\n    \n    rclone copy "${path}/" "${dest}/" \\\n        --verbose \\\n        --transfers "${TRANSFERS}" \\\n        --checkers "${CHECKERS}" \\\n        --bwlimit "${BW_LIMIT}" \\\n        --checksum \\\n        --remove-source-files \\\n        --skip-symlinks \\\n        --log-file "${LOG_FILE}" \\\n        --stats 1s \\\n        --stats-one-line\n    \n    local exit_code=$?\n    \n    if [ ${exit_code} -eq 0 ]; then\n        log "\u5b8c\u6210: ${path}"\n    else\n        log "\u9519\u8bef: ${path} (\u9000\u51fa\u7801 ${exit_code})"\n    fi\n    \n    return ${exit_code}\n}\n\nmain() {\n    mkdir -p "${LOG_DIR}"\n    log "========== rclone\u5907\u4efd\u5f00\u59cb =========="\n    \n    if ! check_time_window && [ "${FORCE_BACKUP:-false}" != "true" ]; then\n        log "\u8df3\u8fc7: \u4e0d\u5728\u65f6\u95f4\u7a97\u53e3\u5185"\n        exit 0\n    fi\n    \n    # \u6d4b\u8bd5\u8fde\u63a5\n    log "\u6d4b\u8bd5\u8fde\u63a5..."\n    rclone listremotes | grep -q "${REMOTE_NAME}"\n    if [ $? -ne 0 ]; then\n        log "\u9519\u8bef: rclone remote \'${REMOTE_NAME}\' \u672a\u914d\u7f6e"\n        exit 1\n    fi\n    \n    # \u6267\u884c\u5907\u4efd\n    for path in "${SOURCE_PATHS[@]}"; do\n        if [ -d "${path}" ]; then\n            run_backup "${path}" || log "\u5907\u4efd\u5931\u8d25: ${path}"\n        fi\n    done\n    \n    log "========== \u5907\u4efd\u5b8c\u6210 =========="\n    \n    # \u8f93\u51fa\u7edf\u8ba1\n    rclone stats \\\n        --output-file "${LOG_DIR}/stats_$(date +%Y%m%d).txt" \\\n        --pickle-file "${LOG_DIR}/stats.pickle"\n}\n\nmain "$@"\n'})}),"\n",(0,d.jsx)(e.h3,{id:"rclone-\u914d\u7f6e\u6587\u4ef6",children:"rclone \u914d\u7f6e\u6587\u4ef6"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:"# ~/.config/rclone/rclone.conf\n[nasbackup]\ntype = sftp\nhost = backup.nas.stars-labs.com\nuser = your_username\nport = 22\nkey_file = ~/.ssh/id_backup_ed25519\nshell_type = unix\nmd5sum_command = md5sum\nsha1sum_command = sha1sum\n"})}),"\n",(0,d.jsx)(e.h3,{id:"systemd-timer\u914d\u7f6e",children:"Systemd Timer\u914d\u7f6e"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-ini",children:'# ~/.config/systemd/user/backup-rclone.service\n[Unit]\nDescription=\u8bad\u7ec3\u6570\u636e\u5907\u4efd (rclone)\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=oneshot\nExecStart=%h/scripts/backup-rclone.sh\nEnvironment="FORCE_BACKUP=false"\nStandardOutput=append:%h/.local/share/backup/logs/rclone.log\nStandardError=append:%h/.local/share/backup/logs/rclone.error.log\n\n[Install]\nWantedBy=default.target\n'})}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-ini",children:"# ~/.config/systemd/user/backup-rclone.timer\n[Unit]\nDescription=\u6bcf\u592922:00\u81ea\u52a8\u5907\u4efd\u8bad\u7ec3\u6570\u636e\n\n[Timer]\nOnCalendar=*-*-* 22:00:00\nPersistent=true\nRandomizedDelaySec=15min\n\n[Install]\nWantedBy=timers.target\n"})}),"\n",(0,d.jsx)(e.h2,{id:"\u66f4\u9ad8\u901f\u65b9\u6848bbcp",children:"\u66f4\u9ad8\u901f\u65b9\u6848\uff1abbcp"}),"\n",(0,d.jsxs)(e.p,{children:["\u5982\u679c",(0,d.jsx)(e.strong,{children:"\u6781\u81f4\u901f\u5ea6"}),"\u662f\u9996\u8981\u9700\u6c42\uff0c\u63a8\u8350 ",(0,d.jsx)(e.strong,{children:"bbcp"}),"\uff1a"]}),"\n",(0,d.jsx)(e.h3,{id:"bbcp-\u4f18\u52bf",children:"bbcp \u4f18\u52bf"}),"\n",(0,d.jsxs)(e.table,{children:[(0,d.jsx)(e.thead,{children:(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.th,{children:"\u7279\u6027"}),(0,d.jsx)(e.th,{children:"bbcp"}),(0,d.jsx)(e.th,{children:"rsync"}),(0,d.jsx)(e.th,{children:"rclone"})]})}),(0,d.jsxs)(e.tbody,{children:[(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"\u5355\u6587\u4ef6\u901f\u5ea6"}),(0,d.jsx)(e.td,{children:"9+ GB/s"}),(0,d.jsx)(e.td,{children:"3-4 GB/s"}),(0,d.jsx)(e.td,{children:"5-7 GB/s"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"\u591a\u6587\u4ef6\u5e76\u884c"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"\u274c"}),(0,d.jsx)(e.td,{children:"\u2705"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"\u5185\u5b58\u5360\u7528"}),(0,d.jsx)(e.td,{children:"\u4f4e"}),(0,d.jsx)(e.td,{children:"\u4e2d"}),(0,d.jsx)(e.td,{children:"\u4e2d"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"\u65ad\u70b9\u7eed\u4f20"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"\u2705"}),(0,d.jsx)(e.td,{children:"\u2705"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"\u52a0\u5bc6"}),(0,d.jsx)(e.td,{children:"\u53ef\u9009"}),(0,d.jsx)(e.td,{children:"\u5fc5\u987bSSH"}),(0,d.jsx)(e.td,{children:"\u53ef\u9009"})]})]})]}),"\n",(0,d.jsx)(e.h3,{id:"bbcp-\u5b89\u88c5",children:"bbcp \u5b89\u88c5"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:"# Ubuntu/Debian\nsudo apt install bbcp\n\n# \u6216\u6e90\u7801\u7f16\u8bd1\ngit clone https://github.com/ltp/bbcp.git\ncd bbcp\nmake\nsudo make install\n"})}),"\n",(0,d.jsx)(e.h3,{id:"bbcp-\u4f7f\u7528",children:"bbcp \u4f7f\u7528"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:'# \u57fa\u672c\u7528\u6cd5\nbbcp -s -z -T "ssh -c aes128-ctr -i ~/.ssh/id_ed25519" \\\n    /data/training/dataset.tar.gz \\\n    user@nas:/backup/dataset.tar.gz\n\n# \u9009\u9879\u8bf4\u660e:\n# -s: \u9759\u9ed8\u6a21\u5f0f\n# -z: \u538b\u7f29\u4f20\u8f93\n# -T: \u6307\u5b9aSSH\u547d\u4ee4\uff08\u52a0\u5bc6\u65b9\u5f0f\uff09\n# -p: \u4fdd\u7559\u6743\u9650\n# -a: \u663e\u793a\u8fdb\u5ea6\n\n# \u591a\u6587\u4ef6\u5e76\u884c\u4f20\u8f93\nbbcp -s -z -T "ssh -c aes128-ctr" \\\n    /data/training/*.tar.gz \\\n    user@nas:/backup/\n\n# \u5e26\u6821\u9a8c\nbbcp -s -z -V -T "ssh -c aes128-ctr" \\\n    /data/training/ \\\n    user@nas:/backup/\n'})}),"\n",(0,d.jsx)(e.h3,{id:"bbcp-\u5b8c\u6574\u811a\u672c",children:"bbcp \u5b8c\u6574\u811a\u672c"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n# ~/scripts/backup-bbcp.sh\n# bbcp\u9ad8\u901f\u5907\u4efd\u811a\u672c\n\nset -euo pipefail\n\nNAS_HOST="backup.nas.stars-labs.com"\nNAS_USER="${USER}"\nNAS_PATH="/backup/${USER}"\nSOURCE_PATHS=(\n    "/data/training"\n    "/data/models"\n)\nBW_LIMIT=""  # bbcp\u81ea\u52a8\u9002\u5e94\nLOG_DIR="${HOME}/.local/share/backup/logs"\n\nlog() {\n    echo "[$(date \'+%Y-%m-%d %H:%M:%S\')] $*" | tee -a "${LOG_DIR}/bbcp_$(date +%Y%m%d).log"\n}\n\nrun_backup() {\n    local src="$1"\n    local dst="${NAS_USER}@${NAS_HOST}:${NAS_PATH}$(dirname ${src})"\n    \n    log "\u5907\u4efd: ${src}"\n    \n    # bbcp\u547d\u4ee4:\n    # -a: \u4fdd\u7559\u5c5e\u6027\n    # -z: \u538b\u7f29\n    # -v: \u8be6\u7ec6\n    # -f: \u5f3a\u5236\u8986\u76d6\n    # -w: \u7a97\u53e3\u5927\u5c0f (16MB\u9002\u5408\u9ad8RTT\u7f51\u7edc)\n    # -T: SSH\u547d\u4ee4\n    \n    bbcp -a -z -f -w 64M \\\n        -T "ssh -c aes128-ctr -i ~/.ssh/id_ed25519 -o Compression=no" \\\n        "${src}/" \\\n        "${dst}/" \\\n        2>&1 | tee -a "${LOG_DIR}/bbcp_$(date +%Y%m%d).log"\n    \n    # \u4f20\u8f93\u5b8c\u6210\u540e\u5220\u9664\u6e90\u6587\u4ef6\n    if [ $? -eq 0 ]; then\n        log "\u5220\u9664\u6e90\u6587\u4ef6: ${src}"\n        rm -rf "${src}"\n    fi\n}\n\nmain() {\n    mkdir -p "${LOG_DIR}"\n    log "========== bbcp\u5907\u4efd\u5f00\u59cb =========="\n    \n    for path in "${SOURCE_PATHS[@]}"; do\n        if [ -d "${path}" ]; then\n            run_backup "${path}"\n        fi\n    done\n    \n    log "========== bbcp\u5907\u4efd\u5b8c\u6210 =========="\n}\n\nmain "$@"\n'})}),"\n",(0,d.jsx)(e.h2,{id:"\u901f\u5ea6\u4f18\u5316\u53c2\u6570\u5bf9\u6bd4",children:"\u901f\u5ea6\u4f18\u5316\u53c2\u6570\u5bf9\u6bd4"}),"\n",(0,d.jsx)(e.h3,{id:"\u4e0d\u540c\u7f51\u7edc\u73af\u5883\u7684\u6700\u4f73\u9009\u62e9",children:"\u4e0d\u540c\u7f51\u7edc\u73af\u5883\u7684\u6700\u4f73\u9009\u62e9"}),"\n",(0,d.jsxs)(e.table,{children:[(0,d.jsx)(e.thead,{children:(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.th,{children:"\u7f51\u7edc\u73af\u5883"}),(0,d.jsx)(e.th,{children:"\u63a8\u8350\u6280\u672f"}),(0,d.jsx)(e.th,{children:"\u5173\u952e\u53c2\u6570"})]})}),(0,d.jsxs)(e.tbody,{children:[(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"10Gbps\u5c40\u57df\u7f51"})}),(0,d.jsx)(e.td,{children:"bbcp/rclone"}),(0,d.jsxs)(e.td,{children:[(0,d.jsx)(e.code,{children:"--transfers 16"}),", ",(0,d.jsx)(e.code,{children:"-w 64M"})]})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"1Gbps\u5c40\u57df\u7f51"})}),(0,d.jsx)(e.td,{children:"rclone"}),(0,d.jsxs)(e.td,{children:[(0,d.jsx)(e.code,{children:"--transfers 8"}),", ",(0,d.jsx)(e.code,{children:"--bwlimit 100M"})]})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"100Mbps\u529e\u516c\u7f51"})}),(0,d.jsx)(e.td,{children:"rclone"}),(0,d.jsxs)(e.td,{children:[(0,d.jsx)(e.code,{children:"--transfers 4"}),", ",(0,d.jsx)(e.code,{children:"--bwlimit 10M"})]})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"\u8de8\u516c\u7f51"})}),(0,d.jsx)(e.td,{children:"rclone + \u538b\u7f29"}),(0,d.jsxs)(e.td,{children:[(0,d.jsx)(e.code,{children:"--compress zstd"}),", ",(0,d.jsx)(e.code,{children:"--bwlimit 5M"})]})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"\u4e0d\u7a33\u5b9a\u7f51\u7edc"})}),(0,d.jsx)(e.td,{children:"rclone"}),(0,d.jsxs)(e.td,{children:[(0,d.jsx)(e.code,{children:"--checkers 8"}),", ",(0,d.jsx)(e.code,{children:"--retries 3"})]})]})]})]}),"\n",(0,d.jsx)(e.h3,{id:"\u53c2\u6570\u8c03\u4f18\u5efa\u8bae",children:"\u53c2\u6570\u8c03\u4f18\u5efa\u8bae"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:"# 10Gbps\u5c40\u57df\u7f51 - \u6781\u81f4\u901f\u5ea6\nrclone copy src remote:dest \\\n    --transfers 16 \\\n    --checkers 32 \\\n    --bwlimit 0 \\          # \u4e0d\u9650\u5236\n    --buffer-size 256M \\\n    --fast-list\n\n# 1Gbps\u7f51\u7edc - \u5e73\u8861\u901f\u5ea6\nrclone copy src remote:dest \\\n    --transfers 8 \\\n    --checkers 16 \\\n    --bwlimit 100M \\\n    --buffer-size 128M\n\n# \u6709\u4e22\u5305\u7f51\u7edc - \u53ef\u9760\u6027\u4f18\u5148\nrclone copy src remote:dest \\\n    --transfers 4 \\\n    --checkers 8 \\\n    --bwlimit 50M \\\n    --retries 3 \\\n    --retries-sleep 1s \\\n    --no-check-certificate false\n"})}),"\n",(0,d.jsx)(e.h2,{id:"\u8fb9\u4f20\u8fb9\u5220\u7b56\u7565",children:"\u8fb9\u4f20\u8fb9\u5220\u7b56\u7565"}),"\n",(0,d.jsx)(e.h3,{id:"\u65b9\u6848\u5bf9\u6bd4",children:"\u65b9\u6848\u5bf9\u6bd4"}),"\n",(0,d.jsxs)(e.table,{children:[(0,d.jsx)(e.thead,{children:(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.th,{children:"\u65b9\u5f0f"}),(0,d.jsx)(e.th,{children:"\u5b89\u5168\u6027"}),(0,d.jsx)(e.th,{children:"\u901f\u5ea6\u5f71\u54cd"}),(0,d.jsx)(e.th,{children:"\u63a8\u8350\u573a\u666f"})]})}),(0,d.jsxs)(e.tbody,{children:[(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"--remove-source-files"})}),(0,d.jsx)(e.td,{children:"\u4e2d"}),(0,d.jsx)(e.td,{children:"\u65e0"}),(0,d.jsx)(e.td,{children:"\u9996\u6b21\u5b8c\u6574\u5907\u4efd"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"--delete-during"})}),(0,d.jsx)(e.td,{children:"\u9ad8"}),(0,d.jsx)(e.td,{children:"\u8f7b\u5fae"}),(0,d.jsx)(e.td,{children:"\u589e\u91cf\u540c\u6b65"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"\u81ea\u5b9a\u4e49\u811a\u672c"}),(0,d.jsx)(e.td,{children:"\u9ad8"}),(0,d.jsx)(e.td,{children:"\u81ea\u5b9a\u4e49"}),(0,d.jsx)(e.td,{children:"\u7279\u6b8a\u9700\u6c42"})]})]})]}),"\n",(0,d.jsx)(e.h3,{id:"\u63a8\u8350\u7b56\u7565",children:"\u63a8\u8350\u7b56\u7565"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:"# \u9996\u6b21\u5907\u4efd\uff08\u5b8c\u6574\u590d\u5236\uff0c\u4e0d\u5220\uff09\nrclone copy src remote:dest \\\n    --transfers 8\n\n# \u540e\u7eed\u5907\u4efd\uff08\u589e\u91cf\u540c\u6b65\uff0c\u8fb9\u4f20\u8fb9\u5220\uff09\nrclone sync src remote:dest \\\n    --transfers 8 \\\n    --delete-during \\\n    --verbose\n\n# \u4f20\u8f93\u5b8c\u7acb\u5373\u5220\u9664\u6e90\u6587\u4ef6\nrclone copy src remote:dest \\\n    --transfers 8 \\\n    --remove-source-files \\\n    --verbose\n"})}),"\n",(0,d.jsx)(e.h2,{id:"\u65b9\u6848\u9009\u62e9\u5efa\u8bae",children:"\u65b9\u6848\u9009\u62e9\u5efa\u8bae"}),"\n",(0,d.jsxs)(e.table,{children:[(0,d.jsx)(e.thead,{children:(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.th,{children:"\u573a\u666f"}),(0,d.jsx)(e.th,{children:"\u63a8\u8350\u65b9\u6848"}),(0,d.jsx)(e.th,{children:"\u539f\u56e0"})]})}),(0,d.jsxs)(e.tbody,{children:[(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"\u901a\u7528\u4f01\u4e1a\u5907\u4efd"})}),(0,d.jsx)(e.td,{children:"rclone"}),(0,d.jsx)(e.td,{children:"\u529f\u80fd\u5168\u3001\u6613\u7ef4\u62a4\u3001\u591a\u5e73\u53f0"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"\u6781\u81f4\u901f\u5ea6\u8981\u6c42"})}),(0,d.jsx)(e.td,{children:"bbcp"}),(0,d.jsx)(e.td,{children:"\u5355\u6587\u4ef610GB/s+"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"\u8de8\u516c\u7f51\u4f20\u8f93"})}),(0,d.jsx)(e.td,{children:"rclone + \u538b\u7f29"}),(0,d.jsx)(e.td,{children:"\u65ad\u70b9\u7eed\u4f20\u3001\u538b\u7f29"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"\u6df7\u5408\u4e91\u5b58\u50a8"})}),(0,d.jsx)(e.td,{children:"rclone"}),(0,d.jsx)(e.td,{children:"100+\u4e91\u540e\u7aef\u652f\u6301"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.strong,{children:"HPC\u73af\u5883"})}),(0,d.jsx)(e.td,{children:"bbcp"}),(0,d.jsx)(e.td,{children:"\u9ad8\u6027\u80fd\u8ba1\u7b97\u539f\u751f\u652f\u6301"})]})]})]}),"\n",(0,d.jsx)(e.h3,{id:"\u6700\u7ec8\u63a8\u8350\u914d\u7f6e",children:"\u6700\u7ec8\u63a8\u8350\u914d\u7f6e"}),"\n",(0,d.jsx)(e.p,{children:"\u5bf9\u4e8e50\u4eba\u89c4\u6a21\u7684\u8bad\u7ec3\u6570\u636e\u5907\u4efd\uff1a"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:"# rclone \u914d\u7f6e\uff08\u63a8\u8350\uff09\nrclone copy /data/training nasbackup:backup/training \\\n    --transfers 8 \\\n    --bwlimit 50M \\\n    --checksum \\\n    --remove-source-files \\\n    --delete-during \\\n    --stats 1s\n"})}),"\n",(0,d.jsx)(e.p,{children:(0,d.jsx)(e.strong,{children:"\u9884\u671f\u6027\u80fd\uff1a"})}),"\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsx)(e.li,{children:"1Gbps\u7f51\u7edc\uff1a400-500 Mbps\u7a33\u5b9a\u4f20\u8f93"}),"\n",(0,d.jsx)(e.li,{children:"\u5355\u6587\u4ef610GB\uff1a\u7ea63\u5206\u949f"}),"\n",(0,d.jsx)(e.li,{children:"\u8fb9\u4f20\u8fb9\u5220\uff1a\u65e0\u989d\u5916\u5f00\u9500"}),"\n"]})]})}function x(n={}){const{wrapper:e}={...(0,c.R)(),...n.components};return e?(0,d.jsx)(e,{...n,children:(0,d.jsx)(a,{...n})}):a(n)}}}]);